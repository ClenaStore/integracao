<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mercatto ‚Ä¢ Consulta de Cupons</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #060b1a;
  --panel: #0e172d;
  --ink: #e5f0ff;
  --muted: #94a3b8;
  --accent: #06b6d4;
  --accent-glow: 0 0 10px #06b6d4aa;
  --green: #16a34a;
  --red: #ef4444;
  --radius: 12px;
}
* { box-sizing: border-box; }
body {
  margin: 0; padding: 0;
  background: radial-gradient(circle at top, #081226, #020617);
  color: var(--ink);
  font-family: 'Inter', sans-serif;
  overflow-x: hidden;
}
header {
  text-align: center;
  padding: 25px 10px 10px;
}
header h1 {
  font-family: 'Orbitron', sans-serif;
  font-size: 1.8rem;
  color: var(--accent);
  text-shadow: var(--accent-glow);
  margin-bottom: 8px;
}
header span {
  font-size: 0.9rem;
  color: var(--muted);
  letter-spacing: 1px;
}
.controls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin: 20px auto;
}
input, select, button {
  background: var(--panel);
  color: var(--ink);
  border: 1px solid #1e293b;
  border-radius: var(--radius);
  padding: 10px 12px;
  font-size: 14px;
  transition: 0.2s ease;
}
input:focus, select:focus, button:hover {
  border-color: var(--accent);
  box-shadow: var(--accent-glow);
  outline: none;
}
button {
  background: var(--accent);
  color: #fff;
  font-weight: 700;
  cursor: pointer;
}
#layout {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
  padding: 10px;
}
.card {
  background: var(--panel);
  border-radius: var(--radius);
  box-shadow: 0 0 20px #0005;
  padding: 15px;
  flex: 1;
  min-width: 340px;
  max-height: 80vh;
  overflow: auto;
  transition: 0.3s ease;
}
.card:hover { box-shadow: 0 0 25px #06b6d440; }
#resumo h2 {
  text-align: center;
  font-size: 1rem;
  margin-bottom: 10px;
  color: var(--accent);
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
th, td {
  padding: 8px;
  border-bottom: 1px solid #1e293b;
}
th { text-align: left; color: var(--accent); }
tr:hover { background: #111b34; }
.total { font-weight: bold; color: var(--green); }
#headerResumo {
  background: linear-gradient(90deg, #06b6d4, #0ea5e9);
  border-radius: var(--radius);
  padding: 10px;
  text-align: center;
  font-weight: 600;
  color: #fff;
  margin-bottom: 10px;
}
.indicadores {
  display: flex;
  justify-content: space-around;
  margin-bottom: 15px;
  text-align: center;
}
.indicador {
  background: #111b34;
  padding: 8px 14px;
  border-radius: var(--radius);
  font-size: 0.9rem;
}
.indicador.cancelado { color: var(--red); }
.indicador.vendido { color: var(--green); }
.loading {
  text-align: center;
  color: var(--accent);
  font-weight: 500;
  animation: pulse 1.2s infinite;
}
@keyframes pulse { 0%,100%{opacity:.6} 50%{opacity:1} }
@media(max-width:900px){#layout{flex-direction:column}}
</style>
</head>
<body>
<header>
  <h1>Consulta de Cupons ‚Äì Mercatto</h1>
  <span>Sistema Integrado de Vendas</span>
</header>

<div class="controls">
  <select id="empresa" onchange="mostrarFinalizadoras()">
    <option value="VAREJO_URL_DELICIA">MERCATTO DEL√çCIA</option>
    <option value="VAREJO_URL_VILLA">VILLA GOURMET</option>
    <option value="VAREJO_URL_PADARIA">PADARIA DEL√çCIA</option>
    <option value="VAREJO_URL_MERCATTO">VAREJO MERCATTO</option>
  </select>
  <input type="date" id="dataInicio">
  <input type="date" id="dataFim">
  <button onclick="consultar()">Consultar</button>
</div>

<div id="layout">
  <div id="resumo" class="card">Aguardando consulta...</div>
  <div id="saida" class="card"><span class="loading">‚è≥ Aguardando consulta...</span></div>
</div>

<script>
// üîπ Finalizadoras espec√≠ficas por empresa
const finalizadorasPorEmpresa = {
  "VAREJO_URL_DELICIA": [
    { id: "1", descricao: "DINHEIRO" },
    { id: "4", descricao: "PIX CNPJ" },
    { id: "15", descricao: "PIX QRCODE POS" },
    { id: "17", descricao: "CART√ÉO CR√âDITO POS" },
    { id: "18", descricao: "CART√ÉO D√âBITO POS" },
    { id: "32", descricao: "PAGAMENTO ONLINE" }
  ],
"VAREJO_URL_VILLA": [
  { id: "1", descricao: "DINHEIRO" },
  { id: "2", descricao: "CARTAO DE DEBITO" },
  { id: "3", descricao: "CARTAO DE CREDITO" },
  { id: "4", descricao: "CREDIARIO CLIENTES" },
  { id: "5", descricao: "CONSUMO FUNCIONARIOS" },
  { id: "6", descricao: "VOUCHER" },
  { id: "11", descricao: "TRANSFERENCIA BANCAR" },
  { id: "12", descricao: "PIX" },
  { id: "17", descricao: "CATALOGO DELIVERY" },
  { id: "18", descricao: "CART CREDITO POS" },
  { id: "19", descricao: "CART DEBITO POS" },
  { id: "20", descricao: "PIX ITAU" },
  { id: "22", descricao: "PIX POS" },
  { id: "23", descricao: "VOUCHER POS" },
  { id: "24", descricao: "BONIFICACAO" },
  { id: "25", descricao: "CONSUMO SOCIO" },
  { id: "26", descricao: "ERROS GARCONS" },
  { id: "27", descricao: "BONIFICACAO GERENCIA" }
],

"VAREJO_URL_PADARIA": [
  { id: "1", descricao: "DINHEIRO" },
  { id: "2", descricao: "CARTAO DE CREDITO" },
  { id: "3", descricao: "CARTAO DE DEBITO" },
  { id: "4", descricao: "PIX" },
  { id: "5", descricao: "BOLETO" },
  { id: "6", descricao: "CONSUMO FUNCIONARIOS" },
  { id: "8", descricao: "CARTAO VOUCHER" },
  { id: "10", descricao: "CREDITO DELIVERY" },
  { id: "11", descricao: "DEBITO DELIVERY" },
  { id: "12", descricao: "PIX OFFLINE" },
  { id: "13", descricao: "PAGAMENTO ONLINE" },
  { id: "14", descricao: "CONSUMO SOCIO" },
  { id: "15", descricao: "VOUCHER POS" },
  { id: "999", descricao: "SEM FATURAMENTO" }
],

  "VAREJO_URL_MERCATTO": [
    { id: "1", descricao: "DINHEIRO" },
    { id: "2", descricao: "CART√ÉO CR√âDITO TEF" },
    { id: "3", descricao: "CART√ÉO D√âBITO TEF" },
    { id: "4", descricao: "PIX CNPJ" },
    { id: "15", descricao: "PIX QRCODE POS" },
    { id: "17", descricao: "CR√âDITO POS" },
    { id: "18", descricao: "D√âBITO POS" }
  ]
};

// Fun√ß√£o para exibir as finalizadoras da empresa selecionada
function mostrarFinalizadoras() {
  const empresa = document.getElementById("empresa").value;
  const lista = finalizadorasPorEmpresa[empresa] || [];
  let txt = "üí≥ Finalizadoras Ativas:\n";
  lista.forEach(f => txt += `‚Ä¢ [${f.id}] ${f.descricao}\n`);
  alert(txt);
}

const brl = n => n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

async function consultar(){
  const dataInicio=document.getElementById('dataInicio').value;
  const dataFim=document.getElementById('dataFim').value;
  const empresaSel=document.getElementById('empresa');
  const empresa=empresaSel.value;
  const empresaNome=empresaSel.options[empresaSel.selectedIndex].text;
  const formasPagamento = finalizadorasPorEmpresa[empresa] || [];

  const resumo=document.getElementById('resumo');
  const saida=document.getElementById('saida');
  resumo.innerHTML=`<div class='loading'>üîÑ Consultando ${empresaNome}...</div>`;
  saida.innerHTML=`<div class='loading'>üì° Acessando base de dados...</div>`;

  try{
    const loginResp=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({empresa})});
    const loginData=await loginResp.json();
    const token=loginData.accessToken||loginData.token;
    if(!token) throw new Error("Token n√£o retornado pela API.");

    const resp=await fetch('/api/recebimentos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,dataInicio,dataFim,empresa})});
    const raw=await resp.json();
    saida.textContent=JSON.stringify(raw,null,2);

    const vendas=raw.items||[];
    if(vendas.length===0){
      resumo.innerHTML=`<div class='loading'>üì≠ Nenhum cupom encontrado para ${empresaNome}.</div>`;
      return;
    }

    let tabela=`<div id="headerResumo">üìç ${empresaNome} ‚Äî ${vendas.length} cupons encontrados</div>`;
    let cancelados=0, validos=0;
    let totalGeral=0;
    const totais={};

    for(const v of vendas){
      if(v.cancelada){ cancelados++; continue; }
      validos++;
      const fins=Array.isArray(v.finalizacoes)?v.finalizacoes:[];
      if(fins.length===0) continue;

      const acrescimo=Number(v.acrescimo||0);
      const desconto=Number(v.desconto||0);
      const trocoCupom=(fins.reduce((acc,f)=>acc+Number(f.troco||0),0))||0;
      const trocoDoa=Number(v.trocoDoacao||0);
      const descMoeda=Number(v.descontoMoeda||0);
      const ajuste=(acrescimo - desconto - trocoCupom - trocoDoa - descMoeda)/fins.length;

      fins.forEach(f=>{
        const idf=String(f.finalizadoraId??"?").replace(/^0+/,"");
        const forma=formasPagamento.find(fp=>fp.id==idf);
        const nome=forma?forma.descricao:`‚ùå Desconhecida (${idf})`;
        const valorBase=Number(f.valor||0);
        const valorFinal=valorBase+ajuste;
        if(!totais[idf]) totais[idf]={nome,total:0};
        totais[idf].total+=valorFinal;
        totalGeral+=valorFinal;
      });
    }

    const percentCancel=(cancelados/vendas.length*100).toFixed(1);
    tabela+=`
      <div class="indicadores">
        <div class="indicador vendido">‚úÖ V√°lidos: <b>${validos}</b></div>
        <div class="indicador cancelado">‚ùå Cancelados: <b>${cancelados}</b> (${percentCancel}%)</div>
      </div>`;

    let totaisHtml=`<h2>üí∞ Totais por Finalizadora</h2><table><tbody>`;
    const ordenado=Object.entries(totais).sort((a,b)=>b[1].total-a[1].total);
    for(const [idf,info] of ordenado){
      totaisHtml+=`<tr><td>${idf} - ${info.nome}</td><td class='total'>${brl(info.total)}</td></tr>`;
    }
    totaisHtml+=`<tr><td><b>TOTAL REAL VENDIDO</b></td><td class='total'>${brl(totalGeral)}</td></tr></tbody></table>`;
    resumo.innerHTML=tabela+totaisHtml;

  }catch(e){
    resumo.innerHTML=`<div class='loading' style='color:var(--red)'>‚ùå Erro: ${e.message}</div>`;
    saida.textContent='Erro: '+e.message;
  }
}
</script>
</body>
</html>
