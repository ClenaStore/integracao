<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Resumo Financeiro ‚Ä¢ Grupo Mercatto</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
:root {
  --bg:#0b1020;--surface:#10172a;--card:#0f172a;
  --text:#e5e7eb;--muted:#94a3b8;--line:rgba(148,163,184,.25);
  --accent:#22d3ee;--accent2:#60a5fa;--radius:12px;
  --shadow:0 20px 60px rgba(2,6,23,.35);
}
*{box-sizing:border-box;font-family:'Inter',system-ui,sans-serif;}
body{margin:0;background:var(--bg);color:var(--text);}
header{text-align:center;padding:20px 10px;background:var(--surface);
  border-bottom:1px solid var(--line);color:var(--accent2);font-weight:800;
  font-size:1.3rem;box-shadow:0 2px 10px #0006;}
.controls{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;
  background:var(--surface);padding:10px;border-bottom:1px solid var(--line);}
.controls button{background:var(--card);color:var(--text);
  border:1px solid var(--line);border-radius:var(--radius);
  padding:8px 12px;font-weight:600;}
.controls button:hover{background:var(--accent);color:#fff;cursor:pointer;}
#painel{display:grid;grid-template-columns:repeat(auto-fit,minmax(330px,1fr));
  gap:18px;padding:20px;max-width:1400px;margin:auto;}
.card{background:var(--card);border:1px solid var(--line);
  border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);
  display:flex;flex-direction:column;transition:.3s;}
.card:hover{transform:translateY(-2px);box-shadow:0 0 20px #06b6d440;}
.card h2{margin:0 0 10px;color:var(--accent2);font-size:1rem;text-transform:uppercase;}
.valor{font-size:1.6rem;font-weight:800;margin-bottom:8px;}
ul{list-style:none;margin:0;padding:0;font-size:.9rem;color:var(--muted);}
ul li{margin-bottom:5px;}
.almoco{margin-top:8px;padding:8px;border:1px dashed var(--line);
  border-radius:8px;font-size:.9rem;color:var(--muted);}
.chart{margin-top:10px;height:240px;}
.loading{text-align:center;color:var(--accent);margin-top:40px;font-weight:600;}
footer{text-align:center;color:var(--muted);font-size:.8rem;padding:10px 0 30px;}
#loading{position:fixed;inset:0;background:rgba(2,6,23,.75);display:none;
  align-items:center;justify-content:center;z-index:3000;}
#loading.show{display:flex;}
.spinner{width:46px;height:46px;border-radius:50%;
  border:4px solid rgba(255,255,255,.25);border-top-color:#fff;
  animation:spin 1s linear infinite;margin:0 auto 10px;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<header>üìä Painel de Entradas ‚Äî Grupo Mercatto</header>

<div class="controls">
  <button onclick="carregar(true)">üîÑ Recarregar Dia</button>
  <button onclick="exportarPDF()">üìÑ PDF</button>
  <button onclick="enviarWhatsapp()">üì≤ WhatsApp</button>
</div>

<div id="painel"><div class="loading">Carregando dados...</div></div>

<div id="loading">
  <div>
    <div class="spinner"></div>
    <div class="loading-text">Carregando dados da API...</div>
  </div>
</div>

<footer>Desenvolvido para Grupo Mercatto & Del√≠cia ‚Ä¢ ¬© 2025</footer>

<script>
/* ============================
   CONFIGURA√á√ïES
============================ */
const empresas = [
  { nome:'MERCATTO', key:'VAREJO_URL_MERCATTO', tipo:'MERCATTO' },
  { nome:'DEL√çCIA GOURMET', key:'VAREJO_URL_DELICIA', tipo:'COM_ALMOCO' },
  { nome:'PADARIA DEL√çCIA', key:'VAREJO_URL_PADARIA', tipo:'SEM_ALMOCO' },
  { nome:'VILLA GOURMET', key:'VAREJO_URL_VILLA', tipo:'COM_ALMOCO' }
];
const brl = n => (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const isAlmoco = hora => {
  if(!hora)return false;
  const [h,m]=hora.split(':').map(Number);
  return (h>=5 && (h<16 || (h===16 && m===0)));
};
function showLoading(){document.getElementById('loading').classList.add('show');}
function hideLoading(){document.getElementById('loading').classList.remove('show');}

/* ============================
   FINALIZADORAS POR EMPRESA
============================ */
const finalizadorasPorEmpresa = {
  "VAREJO_URL_MERCATTO": [
    {id:"1",descricao:"DINHEIRO"},{id:"2",descricao:"CART√ÉO CR√âDITO TEF"},
    {id:"3",descricao:"CART√ÉO D√âBITO TEF"},{id:"4",descricao:"PIX CNPJ"},
    {id:"15",descricao:"PIX QRCODE POS"},{id:"17",descricao:"CR√âDITO POS"},
    {id:"18",descricao:"D√âBITO POS"}
  ],
  "VAREJO_URL_DELICIA": [
    {id:"1",descricao:"DINHEIRO"},{id:"4",descricao:"PIX CNPJ"},
    {id:"15",descricao:"PIX QRCODE POS"},{id:"17",descricao:"CR√âDITO POS"},
    {id:"18",descricao:"D√âBITO POS"},{id:"32",descricao:"PAGAMENTO ONLINE"}
  ],
  "VAREJO_URL_PADARIA": [
  { id: "1", descricao: "DINHEIRO" },
  { id: "2", descricao: "CARTAO DE CREDITO" },
  { id: "3", descricao: "CARTAO DE DEBITO" },
  { id: "4", descricao: "PIX" },
  { id: "5", descricao: "BOLETO" },
  { id: "6", descricao: "CONSUMO FUNCIONARIOS" },
  { id: "8", descricao: "CARTAO VOUCHER" },
  { id: "10", descricao: "CREDITO DELIVERY" },
  { id: "11", descricao: "DEBITO DELIVERY" },
  { id: "12", descricao: "PIX OFFLINE" },
  { id: "13", descricao: "PAGAMENTO ONLINE" },
  { id: "14", descricao: "CONSUMO SOCIO" },
  { id: "15", descricao: "VOUCHER POS" },
  { id: "", descricao: "SEM FATURAMENTO" }
  ],
  "VAREJO_URL_VILLA": [
  { id: "1", descricao: "DINHEIRO" },
  { id: "2", descricao: "CARTAO DE DEBITO" },
  { id: "3", descricao: "CARTAO DE CREDITO" },
  { id: "4", descricao: "CREDIARIO CLIENTES" },
  { id: "5", descricao: "CONSUMO FUNCIONARIOS" },
  { id: "6", descricao: "VOUCHER" },
  { id: "11", descricao: "TRANSFERENCIA BANCAR" },
  { id: "12", descricao: "PIX" },
  { id: "17", descricao: "CATALOGO DELIVERY" },
  { id: "18", descricao: "CART CREDITO POS" },
  { id: "19", descricao: "CART DEBITO POS" },
  { id: "20", descricao: "PIX ITAU" },
  { id: "22", descricao: "PIX POS" },
  { id: "23", descricao: "VOUCHER POS" },
  { id: "24", descricao: "BONIFICACAO" },
  { id: "25", descricao: "CONSUMO SOCIO" },
  { id: "26", descricao: "ERROS GARCONS" },
  { id: "27", descricao: "BONIFICACAO GERENCIA" }
  ]
};

/* ============================
   FUN√á√ÉO PRINCIPAL (CARREGAR)
============================ */
async function carregar(force=false){
  const painel=document.getElementById('painel');
  painel.innerHTML='<div class="loading">üîÑ Carregando dados...</div>';
  showLoading();

  const hoje=new Date();
  const ontem=new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate()-1);
  const dataInicio=ontem.toISOString().slice(0,10);
  const dataFim=ontem.toISOString().slice(0,10);
  const chaveCache=`financeiro_${dataInicio}`;

  let cache=localStorage.getItem(chaveCache);
  if(!force && cache){
    const dados=JSON.parse(cache);
    montarPainel(dados);
    hideLoading();
    console.log('üóÇÔ∏è Dados carregados do cache local');
    return;
  }

  const resultados=[];
  for(const emp of empresas){
    try{
      const loginResp=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({empresa:emp.key})});
      const loginData=await loginResp.json();
      const token=loginData.accessToken||loginData.token;
      if(!token) throw new Error('Falha no login da API.');
      const resp=await fetch('/api/recebimentos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,dataInicio,dataFim,empresa:emp.key})});
      const raw=await resp.json();
      resultados.push({empresa:emp,...raw});
    }catch(e){
      resultados.push({empresa:emp,error:e.message});
    }
  }

  localStorage.setItem(chaveCache,JSON.stringify(resultados));
  montarPainel(resultados);
  hideLoading();
}

/* ============================
   MONTAGEM DOS CARDS
============================ */
function montarPainel(resultados){
  const cards=[];
  for(const res of resultados){
    if(res.error){
      cards.push(`<div class='card'><h2>${res.empresa.nome}</h2><div style='color:#f87171'>‚ùå ${res.error}</div></div>`);
      continue;
    }
    const vendas=res.items||[];
    if(res.empresa.tipo==='MERCATTO'){
      const emporio=vendas.filter(v=>['1','2','3','4','5'].includes(String(v.numeroCaixa||v.caixa)));
      const rest=vendas.filter(v=>!['1','2','3','4','5'].includes(String(v.numeroCaixa||v.caixa)));
      cards.push(gerarCard('CARNEIRO MERCATTO EMP√ìRIO',emporio,'SEM_ALMOCO','VAREJO_URL_MERCATTO'));
      cards.push(gerarCard('CARNEIRO MERCATTO RESTAURANTE',rest,'COM_ALMOCO','VAREJO_URL_MERCATTO'));
    }else{
      cards.push(gerarCard(res.empresa.nome,vendas,res.empresa.tipo,res.empresa.key));
    }
  }
  document.getElementById('painel').innerHTML=cards.join('');
  desenharGraficos();
}

function gerarCard(nome,vendas,tipo,empresaKey){
  let total=0,totalAlmoco=0,cancelados=0,validos=0;
  const formas={};
  const mapFinal=finalizadorasPorEmpresa[empresaKey]||[];
  vendas.forEach(v=>{
    const val=Number(v.valor||v.valorTotal||0);
    const hora=v.horaFechamento||v.hora||'';
    if(v.cancelada){cancelados++;return;}
    validos++;total+=val;
    if(tipo==='COM_ALMOCO' && isAlmoco(hora)) totalAlmoco+=val;
    (v.finalizacoes||[]).forEach(f=>{
      const idF=String(f.finalizadoraId||'');
      const form=mapFinal.find(ff=>ff.id===idF);
      const nomeF=form?`${idF} - ${form.descricao}`:`${idF} - Desconhecida`;
      formas[nomeF]=(formas[nomeF]||0)+Number(f.valor||0);
    });
  });
  let html=`<div class='card'><h2>${nome}</h2>
  <div class='valor'>${brl(total)}</div>
  <div style='display:flex;gap:10px;margin-bottom:10px;'>
    <span style='color:#22c55e'>‚úÖ V√°lidos: ${validos}</span>
    <span style='color:#ef4444'>‚ùå Cancelados: ${cancelados}</span>
  </div><ul>`;
  Object.entries(formas).forEach(([k,v])=>html+=`<li>${k}: ${brl(v)}</li>`);
  html+=`</ul>`;
  if(tipo==='COM_ALMOCO') html+=`<div class='almoco'>üçΩÔ∏è Valor de Almo√ßo (05h‚Äì16h): <b>${brl(totalAlmoco)}</b></div>`;
  html+=`<div class='chart'><canvas></canvas></div></div>`;
  return html;
}

/* ============================
   GR√ÅFICO, PDF E WHATSAPP
============================ */
function desenharGraficos(){
  document.querySelectorAll('.chart').forEach(ch=>{
    const ctx=ch.querySelector('canvas');
    const ul=ch.parentElement.querySelector('ul');
    const labels=[...ul.querySelectorAll('li')].map(li=>li.textContent.split(':')[0]);
    const vals=[...ul.querySelectorAll('li')].map(li=>{
      const val=li.textContent.split('R$')[1]||'0';
      return Number(val.replace('.','').replace(',','.'));
    });
    new Chart(ctx,{type:'bar',
      data:{labels,datasets:[{data:vals,backgroundColor:labels.map((_,i)=>`hsl(${i*50},70%,55%)`)}]},
      options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#aaa'}},y:{ticks:{color:'#aaa'}}}}
    });
  });
}

function exportarPDF(){
  const boxes=document.querySelectorAll(".card");
  boxes.forEach((box,i)=>{
    const wrapper=document.createElement("div");
    wrapper.style.width="1200px";wrapper.style.padding="40px";wrapper.style.background="#fff";
    wrapper.style.color="#111";wrapper.style.fontFamily="Arial,sans-serif";
    const logo=document.createElement("h1");
    logo.innerText="Resumo Financeiro ‚Äî Grupo Mercatto";logo.style.textAlign="center";
    wrapper.appendChild(logo);
    const clone=box.cloneNode(true);clone.style.color="#000";clone.style.pageBreakAfter="always";
    wrapper.appendChild(clone);
    html2pdf().from(wrapper).set({margin:0,filename:`resumo-${i+1}.pdf`,
      image:{type:'jpeg',quality:1},html2canvas:{scale:2,useCORS:true},
      jsPDF:{unit:'px',format:[1200,800],orientation:'landscape'}}).save();
  });
}

function enviarWhatsapp(){
  const boxes=document.querySelectorAll(".card");
  const hoje=new Date();
  const ontem=new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate()-1);
  const di=ontem.toISOString().slice(0,10);
  function fData(x){const [y,m,d]=x.split('-');return`${d}/${m}/${y}`;}
  const periodo=fData(di);
  let msg=`üìä *Resumo Financeiro ‚Äî ${periodo}*\n\n`;
  boxes.forEach(b=>{
    const titulo=b.querySelector("h2").innerText;
    const total=b.querySelector(".valor").innerText;
    msg+=`*${titulo}*\nTotal: ${total}\n`;
    b.querySelectorAll("li").forEach(li=>msg+=`‚Ä¢ ${li.innerText}\n`);
    const alm=b.querySelector(".almoco");
    if(alm) msg+=`${alm.innerText}\n`;
    msg+="\n";
  });
  const numero="5577999761436";
  window.open(`https://wa.me/${numero}?text=${encodeURIComponent(msg)}`,"_blank");
}

/* ============================
   INICIALIZA√á√ÉO
============================ */
document.addEventListener('DOMContentLoaded',()=>{
  carregar();
});
</script>
</body>
</html>
