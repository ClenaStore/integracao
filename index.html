<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Comiss√µes ‚Ä¢ Mercatto Del√≠cia ‚Ä¢ Tempo Real</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#f8fafc;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e2e8f0;
  --accent:#2563eb;--success:#16a34a;--danger:#dc2626;
  --radius:16px;--shadow:0 6px 20px rgba(15,23,42,.08);
}
body{margin:0;font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);}
header{
  background:var(--card);box-shadow:var(--shadow);padding:14px 20px;
  display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:10;
}
header img{height:40px}
h1{margin:0;font-size:1.2rem;font-weight:800;}
main{max-width:1000px;margin:auto;padding:20px;}
.filtros{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:10px;margin-bottom:20px;align-items:end;
}
label{font-weight:600;color:var(--muted);font-size:.9rem}
input[type="date"]{
  width:100%;padding:10px;border:1px solid var(--line);border-radius:var(--radius);
  background:var(--card);color:var(--text);font-weight:600;
}
button{
  padding:10px 16px;border:none;border-radius:var(--radius);font-weight:700;
  background:var(--accent);color:#fff;cursor:pointer;transition:.3s;
}
button:hover{opacity:.9;transform:translateY(-2px)}
section.card{
  background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
  padding:20px;margin-bottom:20px;border:1px solid var(--line);
}
.card h2{margin-top:0;color:var(--accent)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.valor{font-size:1.3rem;font-weight:800;transition:.3s;}
.valor.flash{background:yellow;color:#000;padding:3px 6px;border-radius:8px;}
.sub{color:var(--muted);font-size:.9rem;margin-bottom:6px;}
.totalgeral{
  background:var(--accent);color:#fff;padding:16px;border-radius:var(--radius);
  font-size:1.3rem;font-weight:800;text-align:center;box-shadow:var(--shadow);
}
footer{text-align:center;padding:30px 0;color:var(--muted);font-size:.8rem;}
#progress{
  position:fixed;top:0;left:0;height:4px;width:0%;background:var(--accent);
  transition:width .3s;z-index:9999;
}
/* Console JSON */
#console{
  position:fixed;top:0;right:-450px;width:450px;height:100%;
  background:#0f172a;color:#e2e8f0;overflow:auto;z-index:10000;
  transition:right .4s ease;box-shadow:-4px 0 12px rgba(0,0,0,.3);
  padding:10px;font-size:.85rem;
}
#console.active{right:0;}
#console pre{background:rgba(255,255,255,.08);padding:8px;border-radius:8px;white-space:pre-wrap;}
#toggleConsole{
  position:fixed;bottom:20px;right:20px;background:var(--accent);color:#fff;
  border:none;border-radius:50%;width:56px;height:56px;cursor:pointer;
  box-shadow:var(--shadow);font-size:1.4rem;
}
#statusLog{
  background:#fff;border-radius:var(--radius);padding:10px;margin-top:10px;
  border:1px solid var(--line);font-size:.9rem;color:var(--muted);max-height:200px;overflow:auto;
}
</style>
</head>
<body>
<header>
  <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true">
  <h1>Comiss√µes - Mercatto Del√≠cia ‚Ä¢ Tempo Real</h1>
</header>

<div id="progress"></div>
<div id="console"></div>
<button id="toggleConsole">üñ•Ô∏è</button>

<main>
  <div class="filtros">
    <div>
      <label>Data In√≠cio</label>
      <input type="date" id="inicio">
    </div>
    <div>
      <label>Data Fim</label>
      <input type="date" id="fim">
    </div>
    <button id="btnBuscar">‚ñ∂Ô∏è Iniciar Tempo Real</button>
    <button id="btnParar" style="background:#dc2626;display:none;">‚èπÔ∏è Parar</button>
  </div>

  <section class="card">
    <h2>Relat√≥rio de Comiss√µes</h2>
    <div id="statusLog">Aguardando in√≠cio...</div>
    <div id="relatorio">Escolha o per√≠odo e clique em Iniciar Tempo Real.</div>
    <canvas id="grafico" height="180"></canvas>
  </section>

  <div class="totalgeral" id="totalgeral">R$ 0,00</div>
</main>

<footer>¬© 2025 Grupo DV</footer>

<script>
const empresas = [
  { nome:"CARNEIRO MERCATTO RESTAURANTE", chave:"VAREJO_URL_MERCATTO" },
  { nome:"CARNEIRO MERCATTO EMP√ìRIO", chave:"VAREJO_URL_MERCATTO" }
];
const brl=v=>(Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
let loopAtivo=false, intervalo;
const progress=document.getElementById('progress');
const consoleDiv=document.getElementById('console');
const logDiv=document.getElementById('statusLog');
document.getElementById('toggleConsole').onclick=()=>consoleDiv.classList.toggle('active');

function log(msg, json, tipo='info'){
  const hora=new Date().toLocaleTimeString();
  let icone='‚ÑπÔ∏è';
  if(tipo==='ok') icone='‚úÖ';
  if(tipo==='erro') icone='‚ùå';
  if(tipo==='load') icone='üì¶';
  logDiv.innerHTML+=`<div>${icone} [${hora}] ${msg}</div>`;
  logDiv.scrollTop=logDiv.scrollHeight;
  if(json){
    const pre=document.createElement('pre');
    pre.textContent=JSON.stringify(json,null,2);
    consoleDiv.prepend(pre);
  }
}

async function buscar(){
  const inicio=document.getElementById('inicio').value;
  const fim=document.getElementById('fim').value;
  if(!inicio||!fim){alert('Selecione o per√≠odo completo.');return;}
  loopAtivo=true;
  document.getElementById('btnBuscar').style.display='none';
  document.getElementById('btnParar').style.display='inline-block';
  log('üöÄ Iniciando monitoramento em tempo real...',null,'ok');
  await atualizar(inicio,fim);
  intervalo=setInterval(()=>{if(loopAtivo)atualizar(inicio,fim);},3000);
}

async function atualizar(inicio,fim){
  try{
    progress.style.width='10%';
    const resultados=[];
    for(const emp of empresas){
      log(`üè¢ Empresa: ${emp.nome}`);
      const login=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({empresa:emp.chave})});
      const {accessToken,error}=await login.json();
      if(error){ log(`Erro ao autenticar ${emp.nome}: ${error}`,'','erro'); continue; }
      progress.style.width='30%';
      log(`üîê Token gerado para ${emp.nome}`,'','ok');
      const req=await fetch('/api/recebimentos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        token:accessToken,empresa:emp.chave,dataInicio:inicio,dataFim:fim
      })});
      if(!req.ok){
        const erroTxt=await req.text();
        log(`‚ùå Falha ao obter cupons de ${emp.nome}: ${erroTxt}`,'','erro');
        continue;
      }
      const json=await req.json();
      const qtd=json.items?.length||0;
      log(`üì¶ ${qtd} cupons recebidos (${emp.nome})`, json, qtd>0?'ok':'info');
      resultados.push(...(json.items||[]));
      progress.style.width='70%';
    }
    gerarRelatorio(resultados);
    progress.style.width='100%';
    setTimeout(()=>progress.style.width='0%',1000);
  }catch(e){
    log('‚ùå Erro geral: '+e.message,null,'erro');
    progress.style.width='0%';
  }
}

function gerarRelatorio(cupons){
  const resumo={almoco:{total:0,qtd:0},jantar:{total:0,qtd:0},madrugada:{total:0,qtd:0},cancelados:{total:0,qtd:0}};
  cupons.forEach(c=>{
    const val=Number(c.valor||c.valorServico||0);
    const hora=c.dataHoraFechamentoCupom?.split('T')[1]?.slice(0,5)||'00:00';
    const cancelado=c.cancelado||false;
    if(cancelado){resumo.cancelados.total+=val;resumo.cancelados.qtd++;return;}
    const [h,m]=hora.split(':').map(Number);
    const minutos=h*60+m;
    if(minutos>=600 && minutos<=900){
      resumo.almoco.total+=val;resumo.almoco.qtd++;
    }else if(minutos>901 && minutos<=1439){
      resumo.jantar.total+=val;resumo.jantar.qtd++;
    }else{
      resumo.madrugada.total+=val;resumo.madrugada.qtd++;
    }
  });

  const totalGeral=resumo.almoco.total+resumo.jantar.total+resumo.madrugada.total;
  const rel=document.getElementById('relatorio');
  rel.innerHTML=`
  <div class="grid">
    <div><div class="sub">üçΩÔ∏è Comiss√£o Almo√ßo</div><div class="valor">${brl(resumo.almoco.total)}</div><div class="sub">${resumo.almoco.qtd} tickets</div></div>
    <div><div class="sub">üåÜ Comiss√£o Jantar</div><div class="valor">${brl(resumo.jantar.total)}</div><div class="sub">${resumo.jantar.qtd} tickets</div></div>
    <div><div class="sub">üåô Comiss√£o Madrugada</div><div class="valor">${brl(resumo.madrugada.total)}</div><div class="sub">${resumo.madrugada.qtd} tickets</div></div>
    <div><div class="sub" style="color:var(--danger)">‚ùå Cancelados</div><div class="valor" style="color:var(--danger)">${brl(resumo.cancelados.total)}</div><div class="sub">${resumo.cancelados.qtd} tickets</div></div>
  </div>`;

  const totalEl=document.getElementById('totalgeral');
  totalEl.textContent=`TOTAL GERAL: ${brl(totalGeral)}`;
  totalEl.classList.add('flash');
  setTimeout(()=>totalEl.classList.remove('flash'),500);

  const ctx=document.getElementById('grafico');
  new Chart(ctx,{type:'bar',
    data:{labels:['Almo√ßo','Jantar','Madrugada','Cancelados'],
    datasets:[{data:[resumo.almoco.total,resumo.jantar.total,resumo.madrugada.total,resumo.cancelados.total],
    backgroundColor:['#16a34a','#2563eb','#0ea5e9','#dc2626']}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
  log(`üìä Relat√≥rio atualizado (${cupons.length} cupons processados).`,'','ok');
}

function parar(){
  loopAtivo=false;
  clearInterval(intervalo);
  document.getElementById('btnBuscar').style.display='inline-block';
  document.getElementById('btnParar').style.display='none';
  log('‚èπÔ∏è Monitoramento parado.','','info');
}

document.getElementById('btnParar').onclick=parar;
document.getElementById('btnBuscar').onclick=buscar;

document.addEventListener('DOMContentLoaded',()=>{
  const hoje=new Date(),ini=new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate()-1);
  document.getElementById('inicio').value=ini.toISOString().slice(0,10);
  document.getElementById('fim').value=hoje.toISOString().slice(0,10);
});
</script>
</body>
</html>
