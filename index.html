<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta Cupons Mercatto</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root { 
    --bg:#0b1220;
    --ink:#e5f0ff;
    --muted:#a8b3c7;
    --teal:#06b6d4;
    --red:#ef4444;
    --green:#16a34a;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:'Inter',system-ui;padding:20px;}
  h1{text-align:center;margin-bottom:20px;color:var(--teal);}
  .controls{text-align:center;margin-bottom:20px;}
  input,button{padding:8px 10px;margin:4px;border-radius:6px;border:none;font-size:14px;}
  button{background:var(--teal);color:#fff;font-weight:600;cursor:pointer;}
  #layout{display:flex;gap:40px;align-items:flex-start;justify-content:center;}
  #resumo{width:45%;white-space:pre-wrap;line-height:1.5;font-size:14px;background:#101827;padding:15px;border-radius:10px;overflow:auto;max-height:80vh;}
  #saida{flex:1;background:#111a2e;padding:20px;border-radius:8px;overflow:auto;font-size:12px;color:#00ffaa;max-height:80vh;}
  @media(max-width:900px){#layout{flex-direction:column}#resumo{width:100%}}
</style>
</head>
<body>
  <h1>Consulta Cupons Fiscais ‚Äì Mercatto</h1>

  <div class="controls">
    <input type="date" id="dataInicio">
    <input type="date" id="dataFim">
    <button onclick="consultar()">Consultar</button>
  </div>

  <div id="layout">
    <div id="resumo">Aguardando consulta...</div>
    <pre id="saida">Aguardando consulta...</pre>
  </div>

<script>
const formasPagamento=[
  {"id":"1","descricao":"DINHEIRO"},
  {"id":"2","descricao":"CARTAO CREDITO TEF"},
  {"id":"3","descricao":"CARTAO DEBITO TEF"},
  {"id":"4","descricao":"PIX CNPJ"},
  {"id":"5","descricao":"CONSUMO FUNCIONARIOS"},
  {"id":"6","descricao":"REFEICAO ALIME. TEF"},
  {"id":"7","descricao":"TOTEM CREDITO"},
  {"id":"8","descricao":"TOTEM DEBITO"},
  {"id":"9","descricao":"BONIFICACAO"},
  {"id":"15","descricao":"PIX QRCODE POS"},
  {"id":"16","descricao":"PIX TEF"},
  {"id":"17","descricao":"CREDITO POS"},
  {"id":"18","descricao":"DEBITO POS"},
  {"id":"19","descricao":"CART ALIMENTACAO POS"},
  {"id":"25","descricao":"BOLETO MERCATTO KIDS"},
  {"id":"26","descricao":"CREDIARIO CLIENTES"},
  {"id":"27","descricao":"CONSUMO SOCIO"},
  {"id":"29","descricao":"VOUCHER"},
  {"id":"32","descricao":"PAGAMENTO ONLINE"},
  {"id":"34","descricao":"MARKETING"},
  {"id":"36","descricao":"PREJUIZO"},
  {"id":"999","descricao":"SEM FATURAMENTO"}
];

const brl = n => n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
function valorFinalizacaoLiquido(f){
  const v  = Number(f.valor||0);
  const tr = Number(f.troco||0);
  const td = Number(f.trocoDoacao||0);
  const dm = Number(f.descontoMoeda||0);
  const jp = Number(f.jurosPlano||0);
  return v - tr - td - dm + jp;
}

async function consultar(){
  const dataInicio = document.getElementById('dataInicio').value;
  const dataFim    = document.getElementById('dataFim').value;
  const saida  = document.getElementById('saida');
  const resumo = document.getElementById('resumo');

  resumo.textContent = "üîÑ Processando...";
  saida.textContent  = "üîÑ Buscando dados...";

  try{
    // üîê Login
    const loginResp = await fetch('/api/login',{method:'POST'});
    const {accessToken} = await loginResp.json();

    // üîó Busca cupons
    const resp = await fetch('/api/recebimentos',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({token:accessToken,dataInicio,dataFim})
    });
    const raw = await resp.json();
    saida.textContent = JSON.stringify(raw,null,2);

    const vendas = raw.items || [];
    if(vendas.length===0){
      resumo.textContent = "Nenhum cupom encontrado para o per√≠odo selecionado.";
      return;
    }

    let html = `üßæ Total de Cupons: ${vendas.length}\n\n`;
    const totaisFinalizadoras = {};
    let totalGeral = 0;

    for(const v of vendas){
      const cx = v.numeroCaixa || "???";
      const seq = v.sequencial || v.id || "‚Äî";
      const fins = Array.isArray(v.finalizacoes)?v.finalizacoes:[];
      const canceladoCupom = (v.valorItensCancelados>0 || v.qtdItensCancelados>0);

      fins.forEach(f=>{
        const idf = String(f.finalizadoraId ?? "?").replace(/^0+/, "");
        const forma = formasPagamento.find(fp=>fp.id==idf);
        const nome = forma ? forma.descricao : `‚ùå N√£o catalogada`;
        const val = valorFinalizacaoLiquido(f);

        // soma geral e por finalizadora
        totalGeral += val;
        if(!totaisFinalizadoras[idf]) totaisFinalizadoras[idf] = { nome, total: 0, count: 0 };
        totaisFinalizadoras[idf].total += val;
        totaisFinalizadoras[idf].count++;

        html += 
          `üìÑ Cupom: ${seq}\n`+
          `   Caixa: ${cx}\n`+
          `   Finalizadora ${idf} - ${nome}\n`+
          `   Valor: ${brl(val)}\n`+
          `   Status: ${canceladoCupom ? "‚ùå CANCELADO" : "‚úÖ ATIVO"}\n\n`;
      });
    }

    // =============================
    // üí∞ Totais por finalizadora + total geral
    html += "===============================\n";
    html += "üí∞ TOTAIS POR FINALIZADORA (TODOS OS CUPONS):\n";
    const ordenado = Object.entries(totaisFinalizadoras).sort((a,b)=>b[1].total - a[1].total);
    for(const [idf, info] of ordenado){
      html += `   ${idf} - ${info.nome}: ${brl(info.total)} (${info.count} cupons)\n`;
    }

    html += "\n===============================\n";
    html += `üíµ TOTAL GERAL DO PER√çODO: ${brl(totalGeral)}\n`;

    resumo.textContent = html;

  }catch(e){
    resumo.textContent='‚ùå Erro ao buscar dados.';
    saida.textContent='Erro: '+e.message;
  }
}
</script>
</body>
</html>
