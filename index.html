<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta Recebimentos Mercatto</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0b1220;--card:#111a2e;--ink:#e5f0ff;--muted:#a8b3c7;
    --teal:#06b6d4;--green:#16a34a;--amber:#fbbf24;--red:#ef4444;
  }
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:'Inter',system-ui;
    padding:20px;
  }
  h1{text-align:center;margin-bottom:20px;color:var(--teal);}
  .controls{
    text-align:center;margin-bottom:20px;
  }
  input,button{
    padding:8px 10px;margin:4px;border-radius:6px;border:none;font-size:14px;
  }
  button{background:var(--teal);color:white;cursor:pointer;font-weight:600;}
  #cards{
    display:flex;justify-content:center;gap:20px;flex-wrap:wrap;margin-bottom:25px;
  }
  .card{
    background:var(--card);
    padding:16px 24px;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,.25);
    border:1px solid rgba(255,255,255,.05);
    text-align:center;
    min-width:220px;
  }
  .card h2{margin:0;color:var(--muted);font-size:0.9rem;}
  .card p{margin:4px 0 0;font-size:1.4rem;font-weight:700;}
  #layout{
    display:flex;
    gap:40px;
    align-items:flex-start;
  }
  #resumo{
    width:35%;
    font-size:14px;
    white-space:pre;
    line-height:1.5;
  }
  #saida{
    flex:1;
    background:#111a2e;
    padding:20px;
    border-radius:8px;
    overflow:auto;
    font-size:12px;
    color:#00ffaa;
  }
  @media(max-width:900px){
    #layout{flex-direction:column;}
    #resumo{width:100%;}
  }
</style>
</head>
<body>
  <h1>Consulta Recebimentos Mercatto</h1>

  <div class="controls">
    <input type="date" id="dataInicio">
    <input type="time" id="horaInicio" value="00:00">
    <input type="date" id="dataFim">
    <input type="time" id="horaFim" value="23:59">
    <button onclick="consultar()">Consultar</button>
  </div>

  <div id="cards">
    <div class="card"><h2>Total Geral</h2><p id="totalGeral">R$ 0,00</p></div>
    <div class="card"><h2>Restaurante Mercatto</h2><p id="totalRestaurante">R$ 0,00</p></div>
    <div class="card"><h2>EmpÃ³rio Mercatto</h2><p id="totalEmporio">R$ 0,00</p></div>
  </div>

  <div id="layout">
    <div id="resumo">Aguardando consulta...</div>
    <pre id="saida">Aguardando consulta...</pre>
  </div>

<script>
const formasPagamento = [
  {"id":"2","descricao":"CARTAO CREDITO TEF"},{"id":"3","descricao":"CARTAO DEBITO TEF"},{"id":"5","descricao":"CONSUMO FUNCIONARIOS"},
  {"id":"12","descricao":"PGTO ONLINE DEBITO"},{"id":"9","descricao":"BONIFICACAO"},{"id":"34","descricao":"MARKETING"},
  {"id":"28","descricao":"BOLETO DELICIA INDUS"},{"id":"29","descricao":"VOUCHER"},{"id":"10","descricao":"BOLETO"},
  {"id":"30","descricao":"PGT ONLINE DELIVERY"},{"id":"14","descricao":"PGTO ONLINE DINHEIRO"},{"id":"13","descricao":"PGTO ONLINE PIX"},
  {"id":"11","descricao":"PGTO ONLINE CREDITO"},{"id":"4","descricao":"PIX CNPJ"},{"id":"32","descricao":"PAGAMENTO ONLINE"},
  {"id":"33","descricao":"VOUCHER POS"},{"id":"1","descricao":"DINHEIRO"},{"id":"35","descricao":"VALE MERCATTO"},
  {"id":"36","descricao":"PREJUIZO"},{"id":"16","descricao":"PIX TEF"},{"id":"31","descricao":"PGT ONLINE IFOOD"},
  {"id":"20","descricao":"BOLETO FAMILY PRODUT"},{"id":"17","descricao":"CREDITO POS"},{"id":"18","descricao":"DEBITO POS"},
  {"id":"6","descricao":"REFEICAO ALIME. TEF"},{"id":"19","descricao":"CART ALIMENTACAO POS"},{"id":"7","descricao":"TOTEM CREDITO"},
  {"id":"15","descricao":"PIX QRCODE POS"},{"id":"8","descricao":"TOTEM DEBITO"},{"id":"22","descricao":"BOLETO DELICIA PRODU"},
  {"id":"24","descricao":"BOLETO ALL TIME CHOP"},{"id":"21","descricao":"BOLETO FOODS TIME"},{"id":"23","descricao":"BOLETO MEOS GOURMET"},
  {"id":"25","descricao":"BOLETO MERCATTO KIDS"},{"id":"26","descricao":"CREDIARIO CLIENTES"},{"id":"27","descricao":"CONSUMO SOCIO"}
];

const grupos = {
  "crÃ©dito": ["credito","cartao credito","totem credito","credito pos","pgto online credito","credito delivery","cart credito","crÃ©dito Ã  vista"],
  "dÃ©bito": ["debito","pgto online debito","cartao debito","totem debito","debito pos","debito delivery","cart debito"],
  "pix": ["pix","pgto online pix","qrcode","pix tef","pix cnpj","pix offline","pix itau","pix pos"],
  "online": ["pagamento online","pagamentos online","refeicao","cart alimentacao"],
  "consumo interno": ["funcionario","convenio empresa","consumo funcionarios","consumo musicos"],
  "boleto": ["boleto"],
  "crediÃ¡rio": ["crediario","crediario clientes"],
  "voucher": ["voucher","cartao voucher","voucher pos","voucher delicia","voucher villa"],
  "dinheiro": ["dinheiro","pgto online dinheiro"],
  "bonificaÃ§Ã£o": ["bonificacao"],
  "catÃ¡logo delivery": ["catalogo delivery","catÃ¡logo delivery"],
  "consumo sÃ³cio": ["socio","consumo sÃ³cio","consumo socio"],
  "marketing": ["marketing"],
  "transferÃªncia bancÃ¡ria": ["transferencia bancar","transferencia bancaria"],
  "erros garÃ§om": ["erros garcons"],
  "sem faturamento": ["sem faturamento"],
  "outros": []
};

function encontrarGrupo(descricao){
  const desc = descricao.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  for(const [grupo, termos] of Object.entries(grupos)){
    if(termos.some(t=>desc.includes(t))) return grupo;
  }
  return "outros";
}

// ðŸ§® Soma os totais de restaurante e empÃ³rio
function calcularSetores(vendas){
  let totalGeral = 0;
  let totalRestaurante = 0;
  let totalEmporio = 0;

  vendas.forEach(v=>{
    const caixa = parseInt(v.numeroCaixa || "0");
    const hora = (v.hora || "").padStart(4,"0");
    const valor = v.valor || 0;
    totalGeral += valor;

    // Restaurante: caixas >005, entre 08h e 16h
    if(caixa > 5 && hora >= "0800" && hora <= "1600") totalRestaurante += valor;

    // EmpÃ³rio: caixas 001 a 005
    if(caixa >= 1 && caixa <= 5) totalEmporio += valor;
  });

  document.getElementById("totalGeral").innerText = "R$ " + totalGeral.toFixed(2);
  document.getElementById("totalRestaurante").innerText = "R$ " + totalRestaurante.toFixed(2);
  document.getElementById("totalEmporio").innerText = "R$ " + totalEmporio.toFixed(2);
}

async function consultar(){
  const dataInicio = document.getElementById('dataInicio').value;
  const dataFim = document.getElementById('dataFim').value;
  const horaInicio = document.getElementById('horaInicio').value;
  const horaFim = document.getElementById('horaFim').value;
  const saida = document.getElementById('saida');
  const resumo = document.getElementById('resumo');
  saida.textContent = "ðŸ”„ Buscando dados...";
  resumo.textContent = "ðŸ”„ Processando...";

  try{
    const loginResp = await fetch('/api/login',{method:'POST'});
    const {accessToken} = await loginResp.json();

    const resp = await fetch('/api/recebimentos',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({token:accessToken,dataInicio,dataFim,horaInicio,horaFim})
    });
    const data = await resp.json();
    saida.textContent = JSON.stringify(data,null,2);
    const vendas = data.items || [];

    // Calcula e atualiza os cards
    calcularSetores(vendas);

    // --- Resumo por caixa e grupo ---
    const caixas = {};
    vendas.forEach(v=>{
      const caixa = v.numeroCaixa || "000";
      if(!caixas[caixa]) caixas[caixa] = {};
      v.finalizacoes?.forEach(f=>{
        const forma = formasPagamento.find(fp=>fp.id==f.finalizadoraId);
        const nome = forma ? forma.descricao : "Desconhecida";
        const grupo = encontrarGrupo(nome);
        if(!caixas[caixa][grupo]) caixas[caixa][grupo] = {total:0,count:0};
        caixas[caixa][grupo].total += f.valor || 0;
        caixas[caixa][grupo].count++;
      });
    });

    let html = '';
    for(const [cx, gruposCx] of Object.entries(caixas)){
      html += `Caixa ${cx}\n`;
      for(const [g,info] of Object.entries(gruposCx)){
        html += `â”œâ”€ ${g.charAt(0).toUpperCase()+g.slice(1)}: R$ ${info.total.toFixed(2)} (${info.count} vendas)\n`;
      }
      html += '\n';
    }

    resumo.textContent = html || 'Nenhum dado encontrado.';
  }catch(e){
    saida.textContent = 'Erro: '+e.message;
    resumo.textContent = 'Erro: '+e.message;
  }
}
</script>
</body>
</html>
