<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Resumo de Entradas</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0b1020;
  --surface:#10172a;
  --card:#0f172a;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --line:rgba(148,163,184,.25);
  --accent:#60a5fa;
  --accent2:#22d3ee;
  --shadow:0 20px 60px rgba(2,6,23,.35);
  --radius:14px;
}
*{box-sizing:border-box;}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,sans-serif;}
header{
  display:flex;align-items:center;justify-content:center;
  background:var(--surface);border-bottom:1px solid var(--line);
  padding:14px 10px;font-weight:800;font-size:1.2rem;color:var(--accent);
}
.controls{
  display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
  background:var(--surface);padding:10px 0;border-bottom:1px solid var(--line);
}
.controls input,.controls button{
  background:var(--card);color:var(--text);border:1px solid var(--line);
  padding:8px 10px;border-radius:var(--radius);font-weight:600;
}
.controls button:hover{background:var(--accent);color:#fff;cursor:pointer;}
#painel{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:16px;padding:20px;max-width:1400px;margin:auto;
}
.card{
  background:var(--card);border:1px solid var(--line);
  border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);
  display:flex;flex-direction:column;
}
.card h2{margin:0 0 10px;color:var(--text);font-size:1.1rem;}
.card .valor{
  font-size:1.5rem;font-weight:800;margin-bottom:10px;color:var(--accent);
}
.card ul{list-style:none;margin:0;padding:0;font-size:.9rem;color:var(--muted);}
.card ul li{margin-bottom:4px;}
.card .almoco{
  margin-top:8px;padding:8px;border:1px dashed var(--line);
  border-radius:8px;color:var(--muted);font-size:.9rem;
}
.chart{
  margin-top:10px;position:relative;height:240px;
}
.loading{text-align:center;color:var(--accent);font-weight:700;margin-top:40px;}
</style>
</head>
<body>

<header>üìä Entradas ‚Ä¢ Painel Consolidado</header>

<div class="controls">
  <input type="date" id="dataInicio">
  <input type="date" id="dataFim">
  <button onclick="carregar()">Filtrar</button>
</div>

<div id="painel"><div class="loading">Carregando dados...</div></div>

<script>
const empresas = [
  { nome:'MERCATTO', key:'VAREJO_URL_MERCATTO', tipo:'MERCATTO' },
  { nome:'DEL√çCIA GOURMET', key:'VAREJO_URL_DELICIA' },
  { nome:'PADARIA DEL√çCIA', key:'VAREJO_URL_PADARIA' },
  { nome:'VILLA GOURMET', key:'VAREJO_URL_VILLA' }
];

const brl = v => (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const isAlmoco = hora=>{
  if(!hora) return false;
  const [h,m]=hora.split(':').map(Number);
  const total=h*60+(m||0);
  return total>=300 && total<=960; // 05h‚Äì16h
};

async function carregar(){
  const painel=document.getElementById('painel');
  painel.innerHTML='<div class="loading">üîÑ Atualizando dados...</div>';

  const di=document.getElementById('dataInicio').value;
  const df=document.getElementById('dataFim').value;

  const cards=[];

  for(const emp of empresas){
    try{
      const login=await fetch('/api/login',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({empresa:emp.key})
      });
      const loginData=await login.json();
      const token=loginData.accessToken||loginData.token;
      if(!token) throw new Error('Token inv√°lido.');

      const resp=await fetch('/api/recebimentos',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({token,empresa:emp.key,dataInicio:di,dataFim:df})
      });
      const raw=await resp.json();
      const vendas=raw.items||[];

      if(emp.tipo==='MERCATTO'){
        const emporio=vendas.filter(v=>{
          const cx=String(v.caixa||v.numeroCaixa||'');
          return ['1','2','3','4','5'].includes(cx);
        });
        const rest=vendas.filter(v=>{
          const cx=String(v.caixa||v.numeroCaixa||'');
          return !['1','2','3','4','5'].includes(cx);
        });
        cards.push(gerarCard('CARNEIRO MERCATTO EMP√ìRIO',emporio,false));
        cards.push(gerarCard('CARNEIRO MERCATTO RESTAURANTE',rest,true));
      }else{
        cards.push(gerarCard(emp.nome,vendas,true));
      }
    }catch(e){
      cards.push(`<div class="card"><h2>${emp.nome}</h2><div>${e.message}</div></div>`);
    }
  }
  painel.innerHTML=cards.join('');
  desenharGraficos();
}

function gerarCard(nome,vendas,calcAlmoco){
  const cat={};
  let total=0;let totalAlmoco=0;
  vendas.forEach(v=>{
    if(v.cancelada) return;
    const valor=Number(v.valor||v.valorTotal||0);
    total+=valor;
    const hora=v.horaFechamento||v.hora||'';
    if(calcAlmoco && isAlmoco(hora)) totalAlmoco+=valor;
    const fins=v.finalizacoes||[];
    fins.forEach(f=>{
      const nomeF=f.descricao||f.nome||'OUTROS';
      const val=Number(f.valor||0);
      cat[nomeF]=(cat[nomeF]||0)+val;
    });
  });

  let html=`<div class="card">
  <h2>${nome}</h2>
  <div class="valor">${brl(total)}</div>
  <ul>`;
  Object.entries(cat).forEach(([k,v])=>{
    html+=`<li>${k}: ${brl(v)}</li>`;
  });
  html+='</ul>';
  if(calcAlmoco) html+=`<div class="almoco">üçΩÔ∏è Almo√ßo: <b>${brl(totalAlmoco)}</b></div>`;
  html+=`<div class="chart"><canvas></canvas></div></div>`;
  return html;
}

function desenharGraficos(){
  document.querySelectorAll('.chart').forEach(chartEl=>{
    const canvas=chartEl.querySelector('canvas');
    const ul=chartEl.parentElement.querySelector('ul');
    const labels=[...ul.querySelectorAll('li')].map(li=>li.textContent.split(':')[0]);
    const vals=[...ul.querySelectorAll('li')].map(li=>{
      const val=li.textContent.split('R$')[1]||'0';return Number(val.replace('.','').replace(',','.'));
    });
    new Chart(canvas.getContext('2d'),{
      type:'bar',
      data:{labels,datasets:[{data:vals,backgroundColor:labels.map((_,i)=>`hsl(${i*45},70%,55%)`)}]},
      options:{plugins:{legend:{display:false}},responsive:true,scales:{x:{ticks:{color:'#aaa'}},y:{ticks:{color:'#aaa'}}}}
    });
  });
}

document.addEventListener('DOMContentLoaded',()=>{
  const hoje=new Date();
  const ontem=new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate()-1);
  document.getElementById('dataInicio').value=ontem.toISOString().substring(0,10);
  document.getElementById('dataFim').value=hoje.toISOString().substring(0,10);
  carregar();
});
</script>

</body>
</html>
