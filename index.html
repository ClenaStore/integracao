<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Resumo Financeiro â€¢ Grupo DV</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{
  --bg:#f5f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e2e8f0;
  --accent:#2563eb;--success:#16a34a;--error:#dc2626;
  --radius:16px;--shadow:0 8px 20px rgba(15,23,42,.08);
}
[data-theme="dark"]{
  --bg:#0b1020;--card:#0f172a;--text:#e5e7eb;--muted:#94a3b8;
  --line:rgba(148,163,184,.25);--shadow:0 12px 40px rgba(2,6,23,.35);
}
*{box-sizing:border-box;font-family:'Inter',system-ui,sans-serif}
body{margin:0;background:var(--bg);color:var(--text);transition:.3s background,color;}
header{
  position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:10px;
  padding:14px 18px;background:var(--card);border-bottom:1px solid var(--line);
  box-shadow:var(--shadow);
}
header img{height:42px}
.title{font-weight:800;font-size:clamp(18px,1.6vw,22px)}
.spacer{flex:1}
button{
  cursor:pointer;border:1px solid var(--line);border-radius:var(--radius);
  background:var(--card);color:var(--text);padding:8px 14px;font-weight:700;
  transition:.2s;box-shadow:var(--shadow);
}
button:hover{transform:translateY(-2px);background:var(--accent);color:#fff}
.conteudo{max-width:1300px;margin:auto;padding:20px}
.filtros{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px;margin-bottom:20px;align-items:end;}
label{font-weight:700;font-size:.9rem;color:var(--muted);margin-bottom:4px;display:block}
input,select{
  width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;
  background:var(--card);color:var(--text);font-weight:600;
}
#painel{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:20px;align-items:start}
.card{
  background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
  box-shadow:var(--shadow);padding:18px;overflow:hidden;position:relative;
  transition:.3s ease;transform:translateY(10px);opacity:0;
}
.card.mostrar{opacity:1;transform:translateY(0)}
.card h2{margin:0 0 8px;font-size:1rem;color:var(--accent)}
.card .flag{
  position:absolute;top:10px;right:12px;font-size:20px;color:var(--success);opacity:0;
  transition:.3s;
}
.card.ok .flag{opacity:1}
.valor{font-size:1.8rem;font-weight:800;margin-bottom:8px}
ul{list-style:none;padding:0;margin:0;color:var(--muted);font-weight:600;font-size:.9rem}
li{margin-bottom:4px}
.desconhecida{color:var(--error);font-weight:700}
.chart{margin-top:10px;height:200px}
.legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;font-size:.8rem;color:var(--muted)}
.legend span::before{content:"";width:10px;height:10px;border-radius:50%;background:currentColor;display:inline-block;margin-right:4px}
footer{text-align:center;color:var(--muted);font-size:.8rem;padding:25px 0 40px}
#progress{position:fixed;top:0;left:0;height:4px;background:var(--accent);width:0%;transition:width .3s;z-index:9999;}
.log{font-size:.8rem;color:var(--muted);margin-top:6px}
</style>
</head>
<body>

<header>
  <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="">
  <div class="title">Resumo Financeiro</div>
  <div class="spacer"></div>
  <button id="themeToggle">ðŸŒ“</button>
</header>

<div id="progress"></div>

<div class="conteudo">
  <div class="filtros">
    <div>
      <label>Data</label>
      <input type="date" id="dataFiltro">
    </div>
    <div>
      <label>Empresa</label>
      <select id="empresaFiltro"><option value="">Todas</option></select>
    </div>
    <button onclick="carregar(true)">ðŸ”„ Recarregar</button>
    <button onclick="exportarPDF()">ðŸ“„ PDF</button>
    <button onclick="enviarWhatsapp()">ðŸ“² WhatsApp</button>
  </div>
  <div id="painel"></div>
</div>

<footer>Â© 2025 Grupo DV</footer>

<script>
const empresas=[
  {nome:"CARNEIRO MERCATTO RESTAURANTE",chave:"VAREJO_URL_MERCATTO"},
  {nome:"CARNEIRO MERCATTO EMPÃ“RIO",chave:"VAREJO_URL_MERCATTO"},
  {nome:"DELICIA GOURMET",chave:"VAREJO_URL_DELICIA"},
  {nome:"PADARIA DELICIA",chave:"VAREJO_URL_PADARIA"},
  {nome:"VILLA GOURMET",chave:"VAREJO_URL_VILLA"}
];

const emojiMap={
  DINHEIRO:"ðŸ’µ",PIX:"ðŸ’²",CREDITO:"ðŸ’³",DÃ‰BITO:"ðŸ¦",DEBITO:"ðŸ¦",
  VOUCHER:"ðŸŽŸï¸",CONSUMO:"ðŸ½ï¸",BOLETO:"ðŸ“„",ONLINE:"ðŸ’»",
  TRANSFERENCIA:"ðŸ›ï¸",BONIFICACAO:"ðŸŽ",SOCIO:"ðŸ§‘â€ðŸ¤â€ðŸ§‘",ERROS:"ðŸ§¯",OUTROS:"ðŸ’ "
};
const brl=v=>(Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const getEmoji=(n)=>{const t=n.toUpperCase();for(const k in emojiMap)if(t.includes(k))return emojiMap[k];return "ðŸ’ ";}

function animateValue(el,start,end,duration){
  const range=end-start;let startTime=null;
  function step(ts){
    if(!startTime)startTime=ts;
    const progress=Math.min((ts-startTime)/duration,1);
    el.textContent=brl(start+range*progress);
    if(progress<1)requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

function addCard(emp){
  const painel=document.getElementById('painel');
  painel.insertAdjacentHTML('beforeend',`
    <div class="card" id="card_${emp.chave}">
      <div class="flag">âœ…</div>
      <h2>${emp.nome}</h2>
      <div class="valor">R$ 0,00</div>
      <ul><li>Carregando...</li></ul>
      <div class="chart"><canvas></canvas></div>
      <div class="legend"></div>
      <div class="log"></div>
    </div>`);
  setTimeout(()=>document.getElementById('card_'+emp.chave).classList.add('mostrar'),150);
}

async function carregar(force=false){
  const data=document.getElementById('dataFiltro').value||new Date(Date.now()-86400000).toISOString().slice(0,10);
  const cacheKey="resumo_"+data;
  const painel=document.getElementById('painel');
  painel.innerHTML="";
  empresas.forEach(addCard);
  const progress=document.getElementById('progress');
  progress.style.width='0%';
  
  if(!force && localStorage.getItem(cacheKey)){
    const cache=JSON.parse(localStorage.getItem(cacheKey));
    cache.forEach(d=>atualizarCard(d.empresa,d.json));
    progress.style.width='100%';
    return;
  }

  let concluido=0,total=empresas.length;
  const resultados=[];
  for(const emp of empresas){
    carregarEmpresa(emp,data,resultados).then(()=>{
      concluido++;
      progress.style.width=(concluido/total*100)+"%";
    });
    await new Promise(r=>setTimeout(r,400)); // atraso suave p/ visual sequÃªncia
  }
  await Promise.allSettled(resultados);
  localStorage.setItem(cacheKey,JSON.stringify(resultados));
}

async function carregarEmpresa(emp,data,resultados){
  const card=document.getElementById('card_'+emp.chave);
  const log=card.querySelector('.log');
  const ul=card.querySelector('ul');
  try{
    log.innerHTML="ðŸ”„ Login...";
    const login=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({empresa:emp.chave})});
    const {accessToken}=await login.json();
    log.innerHTML+=" âœ…<br>ðŸ“¦ Buscando dados...";
    const resp=await fetch('/api/recebimentos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:accessToken,empresa:emp.chave,dataInicio:data,dataFim:data})});
    const json=await resp.json();
    resultados.push({empresa:emp,json});
    log.innerHTML+=" âœ…<br>ðŸ’¾ Processando...";
    atualizarCard(emp,json,true);
    log.innerHTML+=" âœ…<br>âœ… Finalizado.";
  }catch(e){
    ul.innerHTML=`<li class='desconhecida'>Erro: ${e.message}</li>`;
    log.innerHTML+=" âŒ "+e.message;
  }
}

function atualizarCard(emp,json,animar=false){
  const card=document.getElementById('card_'+emp.chave);
  const ul=card.querySelector('ul');
  const valorEl=card.querySelector('.valor');
  ul.innerHTML="";
  const itens=json.items||[];
  const formas={};let total=0;
  itens.forEach(v=>{
    total+=Number(v.valorTotal||0);
    (v.finalizacoes||[]).forEach(f=>{
      const nome=(f.finalizadora||"").toUpperCase();
      const key=`${getEmoji(nome)} ${nome}`;
      formas[key]=(formas[key]||0)+Number(f.valor||0);
    });
  });
  animateValue(valorEl,0,total,1000);
  Object.entries(formas).forEach(([k,v])=>{
    const li=document.createElement('li');
    li.textContent=`${k}: ${brl(v)}`;
    if(k.includes("NÃƒO"))li.classList.add('desconhecida');
    ul.appendChild(li);
  });
  desenharGrafico(card);
  card.classList.add('ok');
}

function desenharGrafico(card){
  const ctx=card.querySelector('canvas');
  const lis=[...card.querySelectorAll('li')];
  const labels=lis.map(li=>li.textContent.split(':')[0]);
  const vals=lis.map(li=>Number((li.textContent.split('R$')[1]||'0').replace('.','').replace(',','.')));
  const cores=labels.map((_,i)=>`hsl(${i*40},70%,55%)`);
  new Chart(ctx,{type:'bar',data:{labels,datasets:[{data:vals,backgroundColor:cores}]},
  options:{plugins:{legend:{display:false}},scales:{x:{ticks:{display:false}},y:{beginAtZero:true}}}});
  const legend=card.querySelector('.legend');
  legend.innerHTML="";
  labels.forEach((lab,i)=>{
    const sp=document.createElement('span');
    sp.style.color=cores[i];
    sp.textContent=lab;
    legend.appendChild(sp);
  });
}

function exportarPDF(){
  const cards=document.querySelectorAll('.card');
  cards.forEach((c,i)=>{
    const wrap=document.createElement('div');
    wrap.style.width='1000px';wrap.style.padding='30px';wrap.style.background='#fff';wrap.style.color='#000';
    const h=document.createElement('h1');h.textContent='Resumo Financeiro - Grupo DV';h.style.textAlign='center';wrap.appendChild(h);
    const clone=c.cloneNode(true);wrap.appendChild(clone);
    html2pdf().from(wrap).set({margin:0,filename:`resumo-${i+1}.pdf`,
    image:{type:'jpeg',quality:1},html2canvas:{scale:2,useCORS:true},
    jsPDF:{unit:'px',format:[1000,800],orientation:'landscape'}}).save();
  });
}

function enviarWhatsapp(){
  const cards=document.querySelectorAll('.card');
  let msg="ðŸ“Š *Resumo Financeiro - Grupo DV*\n\n";
  cards.forEach(c=>{
    msg+=`*${c.querySelector('h2').innerText}*\n`;
    c.querySelectorAll('li').forEach(li=>msg+=`â€¢ ${li.innerText}\n`);
    msg+='\n';
  });
  window.open(`https://wa.me/5577999761436?text=${encodeURIComponent(msg)}`,'_blank');
}

document.addEventListener('DOMContentLoaded',()=>{
  const hoje=new Date(),ontem=new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate()-1);
  document.getElementById('dataFiltro').value=ontem.toISOString().slice(0,10);
  carregar();
});
document.getElementById('themeToggle').onclick=()=>{
  const cur=document.documentElement.getAttribute('data-theme')||'light';
  const next=cur==='light'?'dark':'light';
  document.documentElement.setAttribute('data-theme',next);
  localStorage.setItem('dv_theme',next);
};
</script>
</body>
</html>
