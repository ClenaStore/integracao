<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta Cupons Mercatto</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root { 
    --bg:#0b1220;
    --ink:#e5f0ff;
    --muted:#a8b3c7;
    --teal:#06b6d4;
    --red:#ef4444;
    --green:#16a34a;
  }
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:'Inter',system-ui;padding:20px;
  }
  h1{text-align:center;margin-bottom:20px;color:var(--teal);}
  .controls{text-align:center;margin-bottom:20px;}
  input,button,select{
    padding:8px 10px;margin:4px;border-radius:6px;
    border:none;font-size:14px;
  }
  button{background:var(--teal);color:#fff;font-weight:600;cursor:pointer;}
  select{background:#101827;color:var(--ink);}
  #layout{
    display:flex;gap:40px;align-items:flex-start;justify-content:center;
  }
  #resumo{
    width:45%;white-space:pre-wrap;line-height:1.5;font-size:14px;
    background:#101827;padding:15px;border-radius:10px;
    overflow:auto;max-height:80vh;
  }
  #saida{
    flex:1;background:#111a2e;padding:20px;border-radius:8px;
    overflow:auto;font-size:12px;color:#00ffaa;
    max-height:80vh;
  }
  table{width:100%;border-collapse:collapse;margin-bottom:20px;font-size:14px;}
  th,td{border-bottom:1px solid #1f2937;padding:6px;text-align:left;}
  th{color:var(--teal);}
  tr:hover{background:#182237;}
  .total{font-weight:700;color:var(--green);}
  @media(max-width:900px){#layout{flex-direction:column}#resumo{width:100%}}
</style>
</head>
<body>
  <h1>Consulta Cupons Fiscais ‚Äì Mercatto</h1>

  <div class="controls">
    <select id="empresa">
      <option value="VAREJO_URL_DELICIA">MERCATTO DEL√çCIA</option>
      <option value="VAREJO_URL_VILLA">VILLA GOURMET</option>
      <option value="VAREJO_URL_PADARIA">PADARIA DEL√çCIA</option>
    </select>
    <input type="date" id="dataInicio">
    <input type="date" id="dataFim">
    <button onclick="consultar()">Consultar</button>
  </div>

  <div id="layout">
    <div id="resumo">Aguardando consulta...</div>
    <pre id="saida">Aguardando consulta...</pre>
  </div>

<script>
const formasPagamento=[
  {"id":"1","descricao":"DINHEIRO"},
  {"id":"2","descricao":"CARTAO CREDITO TEF"},
  {"id":"3","descricao":"CARTAO DEBITO TEF"},
  {"id":"4","descricao":"PIX CNPJ"},
  {"id":"5","descricao":"CONSUMO FUNCIONARIOS"},
  {"id":"6","descricao":"REFEICAO ALIME. TEF"},
  {"id":"7","descricao":"TOTEM CREDITO"},
  {"id":"8","descricao":"TOTEM DEBITO"},
  {"id":"9","descricao":"BONIFICACAO"},
  {"id":"15","descricao":"PIX QRCODE POS"},
  {"id":"16","descricao":"PIX TEF"},
  {"id":"17","descricao":"CREDITO POS"},
  {"id":"18","descricao":"DEBITO POS"},
  {"id":"19","descricao":"CART ALIMENTACAO POS"},
  {"id":"27","descricao":"CONSUMO SOCIO"},
  {"id":"29","descricao":"VOUCHER"},
  {"id":"32","descricao":"PAGAMENTO ONLINE"},
  {"id":"34","descricao":"MARKETING"},
  {"id":"36","descricao":"PREJUIZO"},
  {"id":"999","descricao":"SEM FATURAMENTO"}
];

const brl = n => n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

async function consultar(){
  const dataInicio = document.getElementById('dataInicio').value;
  const dataFim    = document.getElementById('dataFim').value;
  const empresa    = document.getElementById('empresa').value;
  const saida  = document.getElementById('saida');
  const resumo = document.getElementById('resumo');

  resumo.textContent = "üîÑ Processando...";
  saida.textContent  = "üîÑ Buscando dados...";

  try{
    // Login (enviando nome da empresa)
    const loginResp = await fetch('/api/login',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({empresa})
    });
    const {accessToken} = await loginResp.json();

    // Busca de cupons
    const resp = await fetch('/api/recebimentos',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({token:accessToken,dataInicio,dataFim,empresa})
    });
    const raw = await resp.json();
    saida.textContent = JSON.stringify(raw,null,2);

    const vendas = raw.items || [];
    if(vendas.length===0){
      resumo.textContent = "Nenhum cupom encontrado para o per√≠odo selecionado.";
      return;
    }

    let tabela = `
    <table>
      <thead>
        <tr><th>Caixa</th><th>Finalizadora</th><th>Valor Recebido</th><th>Cupom</th></tr>
      </thead>
      <tbody>
    `;
    const totais = {};
    let totalGeral = 0;

    for (const v of vendas) {
      if (v.cancelada) continue;

      const caixa = v.numeroCaixa || "‚Äî";
      const seq   = v.sequencial || v.id || "‚Äî";
      const fins  = Array.isArray(v.finalizacoes) ? v.finalizacoes : [];
      if (fins.length === 0) continue;

      const acrescimo = Number(v.acrescimo || 0);
      const desconto  = Number(v.desconto || 0);
      const troco     = Number(v.troco || 0);
      const trocoDoa  = Number(v.trocoDoacao || 0);
      const descMoeda = Number(v.descontoMoeda || 0);

      fins.forEach(f => {
        const idf = String(f.finalizadoraId ?? "?").replace(/^0+/, "");
        const forma = formasPagamento.find(fp => fp.id == idf);
        const nome  = forma ? forma.descricao : "‚ùå N√£o catalogada";

        const valorBase = Number(f.valor || 0);
        const ajuste = (acrescimo - desconto - troco - trocoDoa - descMoeda) / fins.length;
        const valorFinal = valorBase + ajuste;

        if(!totais[idf]) totais[idf] = { nome, total: 0 };
        totais[idf].total += valorFinal;
        totalGeral += valorFinal;

        tabela += `<tr>
          <td>${caixa}</td>
          <td>${idf} - ${nome}</td>
          <td>${brl(valorFinal)}</td>
          <td>${seq}</td>
        </tr>`;
      });
    }

    tabela += "</tbody></table>";

    let totaisHtml = "<h3>üí∞ Totais por Finalizadora</h3><table><tbody>";
    const ordenado = Object.entries(totais).sort((a,b)=>b[1].total - a[1].total);
    for(const [idf, info] of ordenado){
      totaisHtml += `<tr><td>${idf} - ${info.nome}</td><td class="total">${brl(info.total)}</td></tr>`;
    }
    totaisHtml += `<tr><td><b>TOTAL GERAL DO PER√çODO</b></td><td class="total">${brl(totalGeral)}</td></tr></tbody></table>`;

    resumo.innerHTML = tabela + totaisHtml;

  }catch(e){
    resumo.textContent='‚ùå Erro ao buscar dados.';
    saida.textContent='Erro: '+e.message;
  }
}
</script>
</body>
</html>
