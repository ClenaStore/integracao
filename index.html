<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Comiss√µes ‚Ä¢ Mercatto Del√≠cia</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#f8fafc;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e2e8f0;
  --accent:#2563eb;--success:#16a34a;--danger:#dc2626;
  --radius:16px;--shadow:0 6px 20px rgba(15,23,42,.08);
}
body{margin:0;font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);}
header{
  background:var(--card);box-shadow:var(--shadow);padding:14px 20px;
  display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:10;
}
header img{height:40px}
h1{margin:0;font-size:1.2rem;font-weight:800;}
main{max-width:1000px;margin:auto;padding:20px;}
.filtros{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:10px;margin-bottom:20px;align-items:end;
}
label{font-weight:600;color:var(--muted);font-size:.9rem}
input[type="date"]{
  width:100%;padding:10px;border:1px solid var(--line);border-radius:var(--radius);
  background:var(--card);color:var(--text);font-weight:600;
}
button{
  padding:10px 16px;border:none;border-radius:var(--radius);font-weight:700;
  background:var(--accent);color:#fff;cursor:pointer;transition:.3s;
}
button:hover{opacity:.9;transform:translateY(-2px)}
section.card{
  background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
  padding:20px;margin-bottom:20px;border:1px solid var(--line);
}
.card h2{margin-top:0;color:var(--accent)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.valor{font-size:1.3rem;font-weight:800;}
.sub{color:var(--muted);font-size:.9rem;margin-bottom:6px;}
.totalgeral{
  background:var(--accent);color:#fff;padding:16px;border-radius:var(--radius);
  font-size:1.3rem;font-weight:800;text-align:center;box-shadow:var(--shadow);
}
footer{text-align:center;padding:30px 0;color:var(--muted);font-size:.8rem;}
#loading{position:fixed;inset:0;background:rgba(255,255,255,.85);display:none;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;color:var(--accent);}
</style>
</head>
<body>
<header>
  <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true">
  <h1>Comiss√µes - Mercatto Del√≠cia</h1>
</header>

<div id="loading">Carregando dados...</div>

<main>
  <div class="filtros">
    <div>
      <label>Data In√≠cio</label>
      <input type="date" id="inicio">
    </div>
    <div>
      <label>Data Fim</label>
      <input type="date" id="fim">
    </div>
    <button onclick="buscar()">üîÑ Consultar</button>
  </div>

  <section class="card">
    <h2>Relat√≥rio de Comiss√µes</h2>
    <div id="relatorio">Escolha o per√≠odo e clique em Consultar.</div>
    <canvas id="grafico" height="180"></canvas>
  </section>

  <div class="totalgeral" id="totalgeral">R$ 0,00</div>
</main>

<footer>¬© 2025 Grupo DV</footer>

<script>
const empresas = [
  { nome:"CARNEIRO MERCATTO RESTAURANTE", chave:"VAREJO_URL_MERCATTO" },
  { nome:"CARNEIRO MERCATTO EMP√ìRIO", chave:"VAREJO_URL_MERCATTO" }
];
const brl=v=>(Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

async function buscar(){
  const inicio=document.getElementById('inicio').value;
  const fim=document.getElementById('fim').value;
  if(!inicio||!fim){alert('Selecione o per√≠odo completo.');return;}
  document.getElementById('loading').style.display='flex';
  const resultados=[];
  for(const emp of empresas){
    try{
      const login=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({empresa:emp.chave})});
      const {accessToken}=await login.json();
      const req=await fetch('/api/recebimentos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        token:accessToken,empresa:emp.chave,dataInicio:inicio,dataFim:fim
      })});
      const json=await req.json();
      resultados.push(...(json.items||[]));
    }catch(e){console.error(e);}
  }
  gerarRelatorio(resultados);
  document.getElementById('loading').style.display='none';
}

function gerarRelatorio(cupons){
  const resumo={almoco:{total:0,qtd:0},jantar:{total:0,qtd:0},madrugada:{total:0,qtd:0},cancelados:{total:0,qtd:0}};
  cupons.forEach(c=>{
    const val=Number(c.valorServico||0);
    const hora=c.dataVenda?.split('T')[1]?.slice(0,5)||'00:00';
    const cancelado=c.cancelado||false;
    if(cancelado){resumo.cancelados.total+=val;resumo.cancelados.qtd++;return;}
    const [h,m]=hora.split(':').map(Number);
    const minutos=h*60+m;
    if(minutos>=600 && minutos<=900){ // 10:00‚Äì15:00
      resumo.almoco.total+=val;resumo.almoco.qtd++;
    }else if(minutos>901 && minutos<=1439){ // 15:01‚Äì23:59
      resumo.jantar.total+=val;resumo.jantar.qtd++;
    }else{ // 00:00‚Äì09:59
      resumo.madrugada.total+=val;resumo.madrugada.qtd++;
    }
  });

  const totalGeral = resumo.almoco.total+resumo.jantar.total+resumo.madrugada.total;
  const rel=document.getElementById('relatorio');
  rel.innerHTML=`
    <div class="grid">
      <div><div class="sub">üçΩÔ∏è Comiss√£o Almo√ßo (10:00‚Äì15:00)</div><div class="valor">${brl(resumo.almoco.total)}</div><div class="sub">${resumo.almoco.qtd} tickets</div></div>
      <div><div class="sub">üåÜ Comiss√£o Jantar (15:01‚Äì23:59)</div><div class="valor">${brl(resumo.jantar.total)}</div><div class="sub">${resumo.jantar.qtd} tickets</div></div>
      <div><div class="sub">üåô Comiss√£o Madrugada (00:00‚Äì09:59)</div><div class="valor">${brl(resumo.madrugada.total)}</div><div class="sub">${resumo.madrugada.qtd} tickets</div></div>
      <div><div class="sub" style="color:var(--danger)">‚ùå Cancelados</div><div class="valor" style="color:var(--danger)">${brl(resumo.cancelados.total)}</div><div class="sub">${resumo.cancelados.qtd} tickets</div></div>
    </div>`;
  document.getElementById('totalgeral').textContent=`TOTAL GERAL DE COMISS√ïES: ${brl(totalGeral)}`;

  const ctx=document.getElementById('grafico');
  new Chart(ctx,{type:'bar',
    data:{labels:['Almo√ßo','Jantar','Madrugada','Cancelados'],
    datasets:[{data:[resumo.almoco.total,resumo.jantar.total,resumo.madrugada.total,resumo.cancelados.total],
    backgroundColor:['#16a34a','#2563eb','#0ea5e9','#dc2626']}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}

document.addEventListener('DOMContentLoaded',()=>{
  const hoje=new Date(),ini=new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate()-30);
  document.getElementById('inicio').value=ini.toISOString().slice(0,10);
  document.getElementById('fim').value=hoje.toISOString().slice(0,10);
});
</script>
</body>
</html>
