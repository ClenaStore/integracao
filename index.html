<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta Cupons Fiscais Mercatto</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root { --bg:#0b1220;--ink:#e5f0ff;--muted:#a8b3c7;--teal:#06b6d4; }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:'Inter',system-ui;padding:20px;}
  h1{text-align:center;margin-bottom:20px;color:var(--teal);}
  .controls{text-align:center;margin-bottom:20px;}
  input,button{padding:8px 10px;margin:4px;border-radius:6px;border:none;font-size:14px;}
  button{background:var(--teal);color:#fff;font-weight:600;cursor:pointer;}
  #cards{display:flex;justify-content:center;gap:20px;flex-wrap:wrap;margin-bottom:18px}
  .card{background:#101827;padding:14px 22px;border-radius:10px;border:1px solid rgba(255,255,255,.06);min-width:220px;text-align:center}
  .card h2{margin:0 0 4px;color:var(--muted);font-size:.9rem}
  .card p{margin:0;font-weight:800;font-size:1.35rem}
  #layout{display:flex;gap:40px;align-items:flex-start}
  #resumo{width:35%;white-space:pre;line-height:1.5;font-size:14px}
  #saida{flex:1;background:#111a2e;padding:20px;border-radius:8px;overflow:auto;font-size:12px;color:#00ffaa}
  @media(max-width:900px){#layout{flex-direction:column}#resumo{width:100%}}
</style>
</head>
<body>
  <h1>Consulta Cupons Fiscais ‚Äì Mercatto</h1>

  <div class="controls">
    <input type="date" id="dataInicio">
    <input type="date" id="dataFim">
    <button onclick="consultar()">Consultar</button>
  </div>

  <div id="cards">
    <div class="card"><h2>Total Geral</h2><p id="totalGeral">R$ 0,00</p></div>
    <div class="card"><h2>Restaurante Mercatto</h2><p id="totalRestaurante">R$ 0,00</p></div>
    <div class="card"><h2>Emp√≥rio Mercatto</h2><p id="totalEmporio">R$ 0,00</p></div>
  </div>

  <div id="layout">
    <div id="resumo">Aguardando consulta...</div>
    <pre id="saida">Aguardando consulta...</pre>
  </div>

<script>
// Formata n√∫mero em reais
const brl = n => n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

function formatarDataISO(data, hora){
  return `${data}T${hora}`;
}

async function consultar(){
  const dataInicio = document.getElementById('dataInicio').value;
  const dataFim = document.getElementById('dataFim').value;
  const saida = document.getElementById('saida');
  const resumo = document.getElementById('resumo');

  if(!dataInicio || !dataFim){
    alert("Selecione a data inicial e final.");
    return;
  }

  saida.textContent = "üîÑ Buscando cupons fiscais...";
  resumo.textContent = "üîÑ Processando...";

  try {
    // Monta URL com os par√¢metros de filtro
    const url = `https://mercatto.varejofacil.com/api/v1/venda/cupons-fiscais?start=0&q=dataVenda=ge=${formatarDataISO(dataInicio,"00:00:00")};dataVenda=le=${formatarDataISO(dataFim,"23:59:59")}&count=1000`;

    const resp = await fetch(url);
    if(!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);

    const raw = await resp.json();
    saida.textContent = JSON.stringify(raw, null, 2);

    const cupons = raw.items || raw || [];

    if(!Array.isArray(cupons) || cupons.length === 0){
      resumo.textContent = "Nenhum cupom encontrado no per√≠odo.";
      return;
    }

    // Totais por tipo
    let totalGeral=0,totalEmporio=0,totalRestaurante=0;
    const caixas={}, naoCatalogadas={};

    cupons.forEach(c=>{
      const cx = c.numeroCaixa || c.caixa || "000";
      if(!caixas[cx]) caixas[cx]={};

      // Total do cupom
      const valorCupom = Number(c.valorTotal || c.valorLiquido || 0);
      totalGeral += valorCupom;

      const cxNum = parseInt(cx,10);
      if(cxNum>=1 && cxNum<=5) totalEmporio+=valorCupom;
      if(cxNum>5) totalRestaurante+=valorCupom;

      // Finalizadoras (se existirem)
      if(c.finalizadoras && Array.isArray(c.finalizadoras)){
        c.finalizadoras.forEach(f=>{
          const nome = f.descricao || f.nome || `FINALIZADORA ${f.id||"?"}`;
          const valor = Number(f.valor||0);
          const grupo = nome.toLowerCase().includes("pix")?"PIX":
                        nome.toLowerCase().includes("credito")?"Cr√©dito":
                        nome.toLowerCase().includes("debito")?"D√©bito":
                        nome.toLowerCase().includes("dinheiro")?"Dinheiro":"N√£o catalogada";
          
          if(!caixas[cx][grupo]) caixas[cx][grupo]={total:0,count:0};
          caixas[cx][grupo].total+=valor;
          caixas[cx][grupo].count++;

          if(grupo==="N√£o catalogada"){
            if(!naoCatalogadas[nome]) naoCatalogadas[nome]=0;
            naoCatalogadas[nome]+=valor;
          }
        });
      }
    });

    // Atualiza cards
    document.getElementById('totalGeral').innerText=brl(totalGeral);
    document.getElementById('totalEmporio').innerText=brl(totalEmporio);
    document.getElementById('totalRestaurante').innerText=brl(totalRestaurante);

    // Gera resumo
    const caixasOrdenadas=Object.keys(caixas).sort((a,b)=>parseInt(a)-parseInt(b));
    let html='';
    for(const cx of caixasOrdenadas){
      html+=`Caixa ${cx}\n`;
      let somaCaixa=0;
      for(const [g,info] of Object.entries(caixas[cx])){
        html+=`‚îú‚îÄ ${g}: ${brl(info.total)} (${info.count} vendas)\n`;
        somaCaixa+=info.total;
      }
      html+=`‚Üí Total Caixa ${cx}: ${brl(somaCaixa)}\n\n`;
    }

    // Lista de finalizadoras n√£o catalogadas
    const desconhecidas = Object.entries(naoCatalogadas);
    if(desconhecidas.length){
      html += `‚ö†Ô∏è Finalizadoras n√£o catalogadas:\n`;
      desconhecidas.forEach(([nome,valor])=>{
        html += `- ${nome}: ${brl(valor)}\n`;
      });
      html += '\n';
    }

    resumo.textContent = html || 'Nenhum dado encontrado no per√≠odo.';

  } catch (e) {
    resumo.textContent = '‚ùå Erro: ' + e.message;
    saida.textContent = e.stack || e.message;
  }
}
</script>

</body>
</html>
