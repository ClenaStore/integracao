<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Recebimentos Mercatto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{font-family:Arial, sans-serif;background:#f4f6fa;margin:0;padding:20px}
    h1{color:#111;text-align:center}
    .container{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);padding:20px}
    .card h2{margin:0 0 10px;font-size:18px;color:#111}
    .valor{margin:6px 0}
    .loading,.error{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:1000}
    .loading{background:rgba(255,255,255,0.8);font-size:20px;color:#2563eb;display:none}
    .error{background:rgba(255,0,0,0.1);color:#b91c1c;font-size:18px;display:none}
    .filtros{text-align:center;margin:20px 0}
    .filtros input{padding:6px;margin:0 4px}
    .filtros button{padding:8px 16px;background:#2563eb;color:#fff;border:none;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>
  <h1>Recebimentos</h1>

  <div class="filtros">
    Data Inicial: <input type="date" id="dataInicial">
    Data Final: <input type="date" id="dataFinal">
    <button onclick="carregar()">Filtrar</button>
  </div>

  <div class="container">
    <div class="card" id="restaurante">
      <h2>CARNEIRO MERCATTO RESTAURANTE</h2>
      <div id="dados-restaurante"></div>
    </div>
    <div class="card" id="emporio">
      <h2>CARNEIRO MERCATTO EMP√ìRIO</h2>
      <div id="dados-emporio"></div>
    </div>
  </div>

  <div class="loading" id="loading">‚è≥ Processando...</div>
  <div class="error" id="error"></div>

<script>
const agrupamentos = {
  "cr√©dito": ["credito","cartao credito","totem credito","credito pos","pgto online credito","credito delivery","cart credito","cr√©dito √† vista"],
  "d√©bito": ["debito","pgto online debito","cartao debito","totem debito","debito pos","debito delivery","cart debito"],
  "pix": ["pix","pgto online pix","qrcode","pix tef","pix cnpj","pix offline","pix itau","pix pos"],
  "online": ["pagamento online","pagamentos online","refeicao","cart alimentacao"],
  "consumo interno": ["funcionario","convenio empresa","consumo funcionarios","consumo musicos"],
  "boleto": ["boleto"],
  "credi√°rio": ["crediario","crediario clientes"],
  "voucher": ["voucher","cartao voucher","voucher pos","voucher delicia","voucher villa"],
  "dinheiro": ["dinheiro","pgto online dinheiro"],
  "bonifica√ß√£o": ["bonificacao"],
  "cat√°logo delivery": ["catalogo delivery","cat√°logo delivery"],
  "consumo s√≥cio": ["socio","consumo s√≥cio","consumo socio"],
  "marketing": ["marketing"],
  "transfer√™ncia banc√°ria": ["transferencia bancar","transferencia bancaria"],
  "erros gar√ßom": ["erros garcons"],
  "sem faturamento": ["sem faturamento"],
  "outros": []
};

const emojis = {
  "dinheiro":"üíµ","cr√©dito":"üí≥","d√©bito":"üèß","pix":"‚ö°",
  "online":"üåê","consumo interno":"üçΩÔ∏è","boleto":"üìú","credi√°rio":"üè¶",
  "voucher":"üéüÔ∏è","bonifica√ß√£o":"üéÅ","cat√°logo delivery":"üì¶",
  "consumo s√≥cio":"üßë‚Äçü§ù‚Äçüßë","marketing":"üì£","transfer√™ncia banc√°ria":"üèõÔ∏è",
  "erros gar√ßom":"‚ùå","sem faturamento":"üö´","outros":"‚ú®"
};

function mostrarErro(msg){
  document.getElementById("error").style.display="flex";
  document.getElementById("error").innerText=msg;
  setTimeout(()=>{document.getElementById("error").style.display="none"},4000);
}

async function carregar(){
  document.getElementById("loading").style.display="flex";
  try{
    const di=document.getElementById("dataInicial").value;
    const df=document.getElementById("dataFinal").value;
    const url=`/api/recebimentos?dataInicial=${di}&dataFinal=${df}`;
    const r=await fetch(url);
    if(!r.ok) throw new Error("Erro na API");
    const dados=await r.json();

    const grupos={restaurante:{},emporio:{}};
    for(const item of dados.items){
      const caixa=parseInt(item.numeroCaixa);
      const loja=(caixa>=1 && caixa<=4)?"emporio":"restaurante";
      const forma=item.finalizadoraNome.toLowerCase();
      let categoria="outros";
      for(const [cat,lista] of Object.entries(agrupamentos)){
        if(lista.some(p=>forma.includes(p))){categoria=cat;break;}
      }
      grupos[loja][categoria]=(grupos[loja][categoria]||0)+item.valor;
    }

    render("dados-restaurante",grupos.restaurante);
    render("dados-emporio",grupos.emporio);

  }catch(e){
    mostrarErro(e.message);
  }
  document.getElementById("loading").style.display="none";
}

function render(id,dados){
  const el=document.getElementById(id);
  el.innerHTML="";
  for(const [cat,valor] of Object.entries(dados)){
    if(valor>0){
      el.innerHTML+=`<div class="valor">${emojis[cat]||"‚ú®"} ${cat.toUpperCase()}: R$ ${valor.toFixed(2)}</div>`;
    }
  }
}
</script>
</body>
</html>
