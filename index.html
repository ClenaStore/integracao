<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Resumo de Entradas - Mercatto e Filiais</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root {
  --bg:#0b1020;--surface:#10172a;--card:#0f172a;
  --text:#e5e7eb;--muted:#94a3b8;--line:rgba(148,163,184,.25);
  --accent:#22d3ee;--accent2:#60a5fa;
  --shadow:0 20px 60px rgba(2,6,23,.35);
  --radius:12px;
}
*{box-sizing:border-box;font-family:'Inter',system-ui,sans-serif;}
body{margin:0;background:var(--bg);color:var(--text);}
header{
  text-align:center;padding:20px 10px;
  background:var(--surface);border-bottom:1px solid var(--line);
  color:var(--accent2);font-weight:800;font-size:1.3rem;
  box-shadow:0 2px 10px #0006;
}
.controls{
  display:flex;gap:10px;justify-content:center;flex-wrap:wrap;
  background:var(--surface);padding:10px 0;border-bottom:1px solid var(--line);
}
.controls input,.controls button{
  background:var(--card);color:var(--text);
  border:1px solid var(--line);border-radius:var(--radius);
  padding:8px 12px;font-weight:600;
}
.controls button:hover{background:var(--accent);color:#fff;cursor:pointer;}
#painel{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(330px,1fr));
  gap:18px;padding:20px;max-width:1400px;margin:auto;
}
.card{
  background:var(--card);border:1px solid var(--line);
  border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);
  display:flex;flex-direction:column;transition:.3s;
}
.card:hover{transform:translateY(-2px);box-shadow:0 0 20px #06b6d440;}
.card h2{margin:0 0 10px;color:var(--accent2);font-size:1rem;text-transform:uppercase;}
.valor{font-size:1.6rem;font-weight:800;margin-bottom:8px;}
ul{list-style:none;margin:0;padding:0;font-size:.9rem;color:var(--muted);}
ul li{margin-bottom:5px;}
.almoco{
  margin-top:8px;padding:8px;border:1px dashed var(--line);
  border-radius:8px;font-size:.9rem;color:var(--muted);
}
.chart{margin-top:10px;height:240px;position:relative;}
.loading{text-align:center;color:var(--accent);margin-top:40px;font-weight:600;}
footer{text-align:center;color:var(--muted);font-size:.8rem;padding:10px 0 30px;}
@keyframes spin{to{transform:rotate(360deg)}}
#loading{
  position:fixed;inset:0;background:rgba(2,6,23,.75);
  display:none;align-items:center;justify-content:center;z-index:3000;
}
#loading.show{display:flex;}
.spinner{width:46px;height:46px;border-radius:50%;
  border:4px solid rgba(255,255,255,.25);border-top-color:#fff;
  animation:spin 1s linear infinite;margin:0 auto 10px;
}
</style>
</head>
<body>

<header>üìä Painel de Entradas ‚Äî Mercatto e Filiais</header>

<div class="controls">
  <input type="date" id="dataInicio">
  <input type="date" id="dataFim">
  <button onclick="carregar()">üîç Consultar</button>
  <button onclick="exportarPDF()">üìÑ PDF</button>
  <button onclick="enviarWhatsapp()">üì≤ WhatsApp</button>
</div>

<div id="painel"><div class="loading">Carregando dados...</div></div>

<div id="loading">
  <div>
    <div class="spinner"></div>
    <div class="loading-text">Carregando dados da API...</div>
  </div>
</div>

<footer>Desenvolvido para Grupo Mercatto & Del√≠cia ‚Ä¢ ¬© 2025</footer>

<script>
const empresas = [
  { nome:'MERCATTO', key:'VAREJO_URL_MERCATTO', tipo:'MERCATTO' },
  { nome:'DEL√çCIA GOURMET', key:'VAREJO_URL_DELICIA' },
  { nome:'PADARIA DEL√çCIA', key:'VAREJO_URL_PADARIA' },
  { nome:'VILLA GOURMET', key:'VAREJO_URL_VILLA' }
];

const brl = n => (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const isAlmoco = hora => {
  if(!hora) return false;
  const [h,m]=hora.split(':').map(Number);
  const total=h*60+(m||0);
  return total>=300 && total<=960; // 05h at√© 16h
};
function showLoading(){document.getElementById('loading').classList.add('show');}
function hideLoading(){document.getElementById('loading').classList.remove('show');}

async function carregar(){
  const painel=document.getElementById('painel');
  painel.innerHTML='<div class="loading">üîÑ Buscando dados...</div>';
  showLoading();
  const di=document.getElementById('dataInicio').value;
  const df=document.getElementById('dataFim').value;
  const cards=[];

  for(const emp of empresas){
    try{
      const loginResp=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({empresa:emp.key})});
      const loginData=await loginResp.json();
      const token=loginData.accessToken||loginData.token;
      if(!token) throw new Error('Falha no login da API.');

      const resp=await fetch('/api/recebimentos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,dataInicio:di,dataFim:df,empresa:emp.key})});
      const raw=await resp.json();
      const vendas=raw.items||[];

      if(emp.tipo==='MERCATTO'){
        const emporio=vendas.filter(v=>{
          const cx=String(v.caixa||v.numeroCaixa||'');
          return ['1','2','3','4','5'].includes(cx);
        });
        const rest=vendas.filter(v=>{
          const cx=String(v.caixa||v.numeroCaixa||'');
          return !['1','2','3','4','5'].includes(cx);
        });
        cards.push(gerarCard('CARNEIRO MERCATTO EMP√ìRIO',emporio,false));
        cards.push(gerarCard('CARNEIRO MERCATTO RESTAURANTE',rest,true));
      }else{
        cards.push(gerarCard(emp.nome,vendas,true));
      }
    }catch(e){
      cards.push(`<div class="card"><h2>${emp.nome}</h2><div style="color:#f87171">‚ùå ${e.message}</div></div>`);
    }
  }

  painel.innerHTML=cards.join('');
  desenharGraficos();
  hideLoading();
}

function gerarCard(nome,vendas,comAlmoco){
  let total=0, totalAlmoco=0, cancelados=0, validos=0;
  const formas={};
  vendas.forEach(v=>{
    const val=Number(v.valor||v.valorTotal||0);
    const hora=v.horaFechamento||v.hora||'';
    if(v.cancelada){cancelados++;return;}
    validos++;
    total+=val;
    if(comAlmoco && isAlmoco(hora)) totalAlmoco+=val;
    (v.finalizacoes||[]).forEach(f=>{
      const nomeF=f.descricao||f.nome||'Outros';
      formas[nomeF]=(formas[nomeF]||0)+Number(f.valor||0);
    });
  });

  let html=`<div class="card">
  <h2>${nome}</h2>
  <div class="valor">${brl(total)}</div>
  <div style="display:flex;gap:10px;margin-bottom:10px;">
    <span style="color:#22c55e;">‚úÖ V√°lidos: ${validos}</span>
    <span style="color:#ef4444;">‚ùå Cancelados: ${cancelados}</span>
  </div>
  <ul>`;
  Object.entries(formas).forEach(([k,v])=>html+=`<li>${k}: ${brl(v)}</li>`);
  html+=`</ul>`;
  if(comAlmoco) html+=`<div class="almoco">üçΩÔ∏è Valor de Almo√ßo (05h‚Äì16h): <b>${brl(totalAlmoco)}</b></div>`;
  html+=`<div class="chart"><canvas></canvas></div></div>`;
  return html;
}

function desenharGraficos(){
  document.querySelectorAll('.chart').forEach(ch=>{
    const ctx=ch.querySelector('canvas');
    const ul=ch.parentElement.querySelector('ul');
    const labels=[...ul.querySelectorAll('li')].map(li=>li.textContent.split(':')[0]);
    const vals=[...ul.querySelectorAll('li')].map(li=>{
      const val=li.textContent.split('R$')[1]||'0';
      return Number(val.replace('.','').replace(',','.'));
    });
    new Chart(ctx,{
      type:'bar',
      data:{labels,datasets:[{data:vals,backgroundColor:labels.map((_,i)=>`hsl(${i*50},70%,55%)`)}]},
      options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#aaa'}},y:{ticks:{color:'#aaa'}}}}
    });
  });
}

function exportarPDF(){
  const boxes=document.querySelectorAll(".card");
  boxes.forEach((box,i)=>{
    const wrapper=document.createElement("div");
    wrapper.style.width="1200px";wrapper.style.padding="40px";wrapper.style.background="#fff";
    wrapper.style.color="#111";wrapper.style.fontFamily="Arial,sans-serif";
    const logo=document.createElement("h1");logo.innerText="Resumo Financeiro ‚Äî Grupo Mercatto";logo.style.textAlign="center";
    wrapper.appendChild(logo);
    const clone=box.cloneNode(true);clone.style.color="#000";clone.style.pageBreakAfter="always";
    wrapper.appendChild(clone);
    html2pdf().from(wrapper).set({margin:0,filename:`resumo-${i+1}.pdf`,
      image:{type:'jpeg',quality:1},html2canvas:{scale:2,useCORS:true},
      jsPDF:{unit:'px',format:[1200,800],orientation:'landscape'}}).save();
  });
}

function enviarWhatsapp(){
  const boxes=document.querySelectorAll(".card");
  const hoje=new Date();
  const di=document.getElementById("dataInicio").value;
  const df=document.getElementById("dataFim").value;
  function fData(x){const [y,m,d]=x.split('-');return`${d}/${m}/${y}`;}
  const periodo=(di===df)?fData(di):`${fData(di)} a ${fData(df)}`;
  let msg=`üìä *Resumo Financeiro ‚Äî ${periodo}*\n\n`;
  boxes.forEach(b=>{
    const titulo=b.querySelector("h2").innerText;
    const total=b.querySelector(".valor").innerText;
    msg+=`*${titulo}*\nTotal: ${total}\n`;
    b.querySelectorAll("li").forEach(li=>msg+=`‚Ä¢ ${li.innerText}\n`);
    const alm=b.querySelector(".almoco");
    if(alm) msg+=`${alm.innerText}\n`;
    msg+="\n";
  });
  const numero="5577999761436";
  window.open(`https://wa.me/${numero}?text=${encodeURIComponent(msg)}`,"_blank");
}

document.addEventListener('DOMContentLoaded',()=>{
  const hoje=new Date();
  const ontem=new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate()-1);
  document.getElementById('dataInicio').value=ontem.toISOString().substring(0,10);
  document.getElementById('dataFim').value=hoje.toISOString().substring(0,10);
  carregar();
});
</script>
</body>
</html>
