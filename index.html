<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üí† Painel Multilojas ‚Äì Cupons em Tempo Real</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg:#060b1a; --panel:#0e172d; --ink:#e5f0ff;
  --muted:#94a3b8; --accent:#06b6d4; --green:#16a34a;
  --red:#ef4444; --radius:12px; --shadow:0 0 15px #0006;
}
*{box-sizing:border-box}
body{
  margin:0; background:radial-gradient(circle at top,#081226,#020617);
  color:var(--ink); font-family:'Inter',sans-serif; overflow-x:hidden;
}
header{text-align:center;padding:25px 10px 10px;}
header h1{font-family:'Orbitron',sans-serif;font-size:1.8rem;color:var(--accent);text-shadow:0 0 10px #06b6d4aa;margin:0;}
header span{font-size:0.9rem;color:var(--muted);}
.controls{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin:20px auto;}
input,select,button{
  background:var(--panel);color:var(--ink);border:1px solid #1e293b;
  border-radius:var(--radius);padding:10px 12px;font-size:14px;transition:0.2s;
}
input:focus,select:focus,button:hover{border-color:var(--accent);box-shadow:0 0 10px #06b6d4aa;outline:none;}
button{background:var(--accent);color:#fff;font-weight:700;cursor:pointer;}
#painel{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;padding:10px;max-width:1200px;margin:auto;}
.card{
  background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);
  padding:15px;transition:0.3s;position:relative;
}
.card:hover{box-shadow:0 0 25px #06b6d440;}
.card h2{font-size:1.1rem;margin-bottom:8px;color:var(--accent);}
.total{font-size:1.5rem;font-weight:700;color:var(--green);}
.chartBox{position:relative;height:200px;}
.loading{text-align:center;color:var(--accent);font-weight:500;animation:pulse 1.2s infinite;}
@keyframes pulse{0%,100%{opacity:.6}50%{opacity:1}}
.modal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:#000a;display:none;align-items:center;justify-content:center;
}
.modal-content{
  background:var(--panel);padding:20px;border-radius:var(--radius);
  max-width:90%;max-height:90%;overflow:auto;box-shadow:var(--shadow);
}
.modal-content h3{text-align:center;color:var(--accent);}
@media(max-width:900px){#painel{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>üí† Painel Multilojas ‚Äì Cupons</h1>
  <span>Monitoramento de Vendas em Tempo Real</span>
</header>

<div class="controls">
  <input type="date" id="dataInicio">
  <input type="date" id="dataFim">
  <button onclick="consultarTodas()">üîÑ Atualizar</button>
</div>

<div id="painel">
  <div class="loading">‚è≥ Carregando dados...</div>
</div>

<div id="modal" class="modal" onclick="fecharModal(event)">
  <div class="modal-content" id="modalContent"></div>
</div>

<script>
const empresas = [
  { nome:'DEL√çCIA GOURMET', key:'VAREJO_URL_DELICIA' },
  { nome:'VILLA GOURMET', key:'VAREJO_URL_VILLA' },
  { nome:'PADARIA DEL√çCIA', key:'VAREJO_URL_PADARIA' },
  { nome:'MERCATTO DEL√çCIA', key:'VAREJO_URL_MERCATTO' }
];
const brl = n => n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const painel = document.getElementById('painel');
const hoje = new Date();
document.getElementById('dataInicio').valueAsDate = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()-1);
document.getElementById('dataFim').valueAsDate = hoje;

// üîπ Fun√ß√£o principal: consultar todas as empresas
async function consultarTodas(){
  painel.innerHTML = '<div class="loading">üîÑ Atualizando dados de todas as empresas...</div>';
  const di = document.getElementById('dataInicio').value;
  const df = document.getElementById('dataFim').value;
  const cards = [];

  for(const emp of empresas){
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<h2>${emp.nome}</h2><div class="loading">Carregando...</div>`;
    painel.appendChild(card);

    try{
      const login = await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({empresa:emp.key})});
      const dataLogin = await login.json();
      const token = dataLogin.accessToken || dataLogin.token;
      if(!token) throw new Error('Token n√£o retornado.');

      const resp = await fetch('/api/recebimentos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token,dataInicio:di,dataFim:df,empresa:emp.key})});
      const data = await resp.json();
      const vendas = Array.isArray(data.items)?data.items:[];

      if(vendas.length===0){ card.innerHTML=`<h2>${emp.nome}</h2><div class='loading'>üì≠ Nenhum cupom encontrado.</div>`; continue; }

      let total=0, cancel=0;
      vendas.forEach(v=>{
        if(v.cancelada) cancel++;
        else total += Number(v.valor||v.valorTotal||0);
      });
      const percentCancel = ((cancel/vendas.length)*100).toFixed(1);

      // Render resumo e gr√°fico
      card.innerHTML = `
        <h2>${emp.nome}</h2>
        <div>Total Vendido</div>
        <div class="total">${brl(total)}</div>
        <canvas id="chart_${emp.key}" class="chartBox"></canvas>
        <div style="text-align:center;color:var(--muted);font-size:0.8rem;">Cancelados: ${cancel} (${percentCancel}%)</div>
      `;
      desenharGrafico(emp.key, vendas);

      card.onclick = ()=>abrirModal(emp.nome, vendas);
    }catch(e){
      card.innerHTML = `<h2>${emp.nome}</h2><div class='loading' style='color:var(--red)'>‚ùå Erro: ${e.message}</div>`;
    }
  }
}

// üîπ Gera gr√°fico simples por empresa
function desenharGrafico(key, vendas){
  const ctx = document.getElementById('chart_'+key);
  if(!ctx) return;
  const dias = {};
  vendas.forEach(v=>{
    const d = (v.dataVenda||v.data||'').slice(0,10);
    if(!dias[d]) dias[d]=0;
    if(!v.cancelada) dias[d]+=Number(v.valor||v.valorTotal||0);
  });
  const labels = Object.keys(dias);
  const valores = Object.values(dias);
  new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[{label:'Vendas Di√°rias',data:valores,backgroundColor:'#06b6d4'}]},
    options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}}
  });
}

// üîπ Modal detalhado com JSON formatado
function abrirModal(nome,vendas){
  const modal=document.getElementById('modal');
  const conteudo=document.getElementById('modalContent');
  const total=vendas.filter(v=>!v.cancelada).reduce((a,b)=>a+Number(b.valor||b.valorTotal||0),0);
  conteudo.innerHTML=`
    <h3>${nome}</h3>
    <p><b>Total:</b> ${brl(total)} | <b>Cupons:</b> ${vendas.length}</p>
    <pre style="white-space:pre-wrap;font-size:12px;background:#111b34;padding:10px;border-radius:10px;max-height:60vh;overflow:auto;">
${JSON.stringify(vendas.slice(0,10),null,2)}\n... (${vendas.length} registros)
    </pre>`;
  modal.style.display='flex';
}
function fecharModal(e){ if(e.target.id==='modal') e.currentTarget.style.display='none'; }

consultarTodas();
</script>
</body>
</html>
