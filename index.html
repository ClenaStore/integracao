<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Recebimentos ‚Ä¢ Mercatto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Recebimentos</h1>
    <div class="filtros">
      <label>Data Inicial: <input type="date" id="dataInicial"></label>
      <label>Data Final: <input type="date" id="dataFinal"></label>
      <button id="btnFiltrar">Filtrar</button>
    </div>
  </header>

  <!-- Overlay de carregamento -->
  <div id="overlay" class="overlay hidden">
    <div class="spinner"></div>
    <p>Processando dados...</p>
  </div>

  <!-- Mensagem de erro -->
  <div id="erro" class="erro hidden"></div>

  <main id="resultado" class="grid"></main>

  <script>
    const agrupamentos = {
      "üí≥ CR√âDITO": ["credito", "cartao credito", "totem credito", "credito pos", "pgto online credito", "credito delivery", "cart credito", "cr√©dito √† vista"],
      "üèß D√âBITO": ["debito", "pgto online debito", "cartao debito", "totem debito", "debito pos", "debito delivery", "cart debito"],
      "‚ö° PIX": ["pix", "pgto online pix", "qrcode", "pix tef", "pix cnpj", "pix offline", "pix itau", "pix pos"],
      "üåê ONLINE": ["pagamento online", "pagamentos online", "refeicao", "cart alimentacao"],
      "üçΩ CONSUMO INTERNO": ["funcionario", "convenio empresa", "consumo funcionarios", "consumo musicos"],
      "üìÑ BOLETO": ["boleto"],
      "üìù CREDI√ÅRIO": ["crediario", "crediario clientes"],
      "üéü VOUCHER": ["voucher", "cartao voucher", "voucher pos", "voucher delicia", "voucher villa"],
      "üíµ DINHEIRO": ["dinheiro", "pgto online dinheiro"],
      "üéÅ BONIFICA√á√ÉO": ["bonificacao"],
      "üì¶ CAT√ÅLOGO DELIVERY": ["catalogo delivery", "cat√°logo delivery"],
      "üë• CONSUMO S√ìCIO": ["socio", "consumo s√≥cio", "consumo socio"],
      "üì¢ MARKETING": ["marketing"],
      "üè¶ TRANSF. BANC√ÅRIA": ["transferencia bancar", "transferencia bancaria"],
      "üôç ERROS GAR√áOM": ["erros garcons"],
      "üö´ SEM FATURAMENTO": ["sem faturamento"],
      "‚ú≥ OUTROS": []
    };

    const lojas = {
      restaurante: "CARNEIRO MERCATTO RESTAURANTE",
      emporio: "CARNEIRO MERCATTO EMP√ìRIO"
    };

    document.getElementById("btnFiltrar").addEventListener("click", carregar);

    async function carregar() {
      const dataInicial = document.getElementById("dataInicial").value;
      const dataFinal = document.getElementById("dataFinal").value;
      const overlay = document.getElementById("overlay");
      const erro = document.getElementById("erro");
      const resultado = document.getElementById("resultado");

      erro.classList.add("hidden");
      overlay.classList.remove("hidden");
      resultado.innerHTML = "";

      try {
        const res = await fetch(`/api/recebimentos?dataInicial=${dataInicial}&dataFinal=${dataFinal}`);
        if (!res.ok) throw new Error("Erro na API");
        const dados = await res.json();

        const agrupados = processarDados(dados.items || []);
        renderizar(agrupados);
      } catch (e) {
        erro.textContent = "‚ùå Falha ao carregar dados: " + e.message;
        erro.classList.remove("hidden");
      } finally {
        overlay.classList.add("hidden");
      }
    }

    function processarDados(items) {
      const lojasDados = { restaurante: {}, emporio: {}, almoco: {} };

      for (let item of items) {
        const caixa = item.numeroCaixa;
        const nomeFinalizadora = (item.finalizadora || "").toLowerCase();
        const valor = parseFloat(item.valorLiquido || 0);
        const hora = new Date(item.data).getHours();

        let loja = null;
        if (caixa === "001" || caixa === "002" || caixa === "005") loja = "restaurante";
        if (caixa === "003" || caixa === "004") loja = "emporio";

        if (!loja) continue;

        // verifica se √© almo√ßo
        if (hora >= 3 && hora <= 16) {
          lojasDados.almoco["ALMO√áO"] = (lojasDados.almoco["ALMO√áO"] || 0) + valor;
        }

        // acha o agrupamento
        for (let [categoria, aliases] of Object.entries(agrupamentos)) {
          if (aliases.some(alias => nomeFinalizadora.includes(alias))) {
            lojasDados[loja][categoria] = (lojasDados[loja][categoria] || 0) + valor;
          }
        }
      }

      return lojasDados;
    }

    function renderizar(dados) {
      const resultado = document.getElementById("resultado");
      resultado.innerHTML = "";

      for (let loja of ["restaurante", "emporio"]) {
        const valores = dados[loja];
        if (!valores) continue;

        let total = Object.values(valores).reduce((a, b) => a + b, 0);

        let card = `<section class="card">
          <h2>${lojas[loja]} ‚Äî R$ ${total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</h2>
          <ul>`;
        for (let [categoria, valor] of Object.entries(valores)) {
          if (valor > 0) {
            card += `<li>${categoria}: <b>R$ ${valor.toLocaleString("pt-BR",{minimumFractionDigits:2})}</b></li>`;
          }
        }
        card += `</ul></section>`;
        resultado.innerHTML += card;
      }

      if (dados.almoco["ALMO√áO"]) {
        resultado.innerHTML += `
          <section class="card destaque">
            <h2>üçΩ Vendas de Almo√ßo</h2>
            <p>Total: <b>R$ ${dados.almoco["ALMO√áO"].toLocaleString("pt-BR",{minimumFractionDigits:2})}</b></p>
          </section>
        `;
      }
    }
  </script>
</body>
</html>
