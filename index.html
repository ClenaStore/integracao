<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Resumo Financeiro • Grupo DV</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
:root {
  --bg:#0b1020;--surface:#10172a;--card:#0f172a;
  --text:#e5e7eb;--muted:#94a3b8;--line:rgba(148,163,184,.25);
  --accent:#22d3ee;--accent2:#60a5fa;--radius:12px;
  --shadow:0 20px 60px rgba(2,6,23,.35);
}
[data-theme="light"]{
  --bg:#f6f7fb;--surface:#fff;--card:#fff;--text:#0f172a;
  --muted:#475569;--line:#e5e7eb;--shadow:0 16px 36px rgba(15,23,42,.08);
}
*{box-sizing:border-box;font-family:'Inter',system-ui,sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;background:color-mix(in srgb,var(--surface) 90%,transparent);
  backdrop-filter:saturate(160%) blur(6px);border-bottom:1px solid var(--line);
  padding:12px 16px;display:flex;align-items:center;gap:10px;z-index:50;}
header img{height:40px}
.title{font-weight:800;font-size:clamp(18px,1.6vw,22px)}
.spacer{flex:1}
button{cursor:pointer;transition:.2s;background:var(--surface);color:var(--text);
  border:1px solid var(--line);border-radius:10px;padding:8px 12px;font-weight:700;}
button:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
.conteudo{max-width:1200px;margin:auto;padding:20px}
.filtros{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px;margin-bottom:20px;align-items:end;}
label{font-weight:700;font-size:.9rem;color:var(--muted);margin-bottom:4px;display:block}
input,select{padding:10px;border:1px solid var(--line);border-radius:8px;
  background:var(--surface);color:var(--text);width:100%;font-weight:600}
#painel{display:grid;grid-template-columns:repeat(auto-fit,minmax(330px,1fr));gap:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
  box-shadow:var(--shadow);padding:16px;overflow:hidden;transition:.3s;}
.card:hover{transform:translateY(-2px);box-shadow:0 0 20px #06b6d440;}
.card h2{margin:0 0 8px;color:var(--accent2);font-size:1rem;text-transform:uppercase}
.valor{font-size:1.6rem;font-weight:800;margin-bottom:8px}
ul{list-style:none;padding:0;margin:0;color:var(--muted)}
li{margin-bottom:5px}
.desconhecida{color:#ef4444;font-weight:700}
.chart{margin-top:10px;height:240px}
.legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;font-size:.8rem;color:var(--muted)}
.legend span::before{content:"";width:10px;height:10px;border-radius:50%;background:currentColor;display:inline-block;margin-right:4px}
footer{text-align:center;color:var(--muted);font-size:.8rem;padding:20px 0 40px}
#loading{position:fixed;inset:0;background:rgba(2,6,23,.75);display:none;align-items:center;justify-content:center;z-index:999;color:#fff;}
#loading.show{display:flex;}
.spinner{width:46px;height:46px;border-radius:50%;border:4px solid rgba(255,255,255,.25);
  border-top-color:#fff;animation:spin 1s linear infinite;margin-bottom:10px}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<header>
  <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true">
  <div class="title">Resumo de Entradas</div>
  <div class="spacer"></div>
  <button id="themeToggle">🌓 Tema</button>
</header>

<div class="conteudo">
  <div class="filtros">
    <div>
      <label>Data</label>
      <input type="date" id="dataFiltro">
    </div>
    <div>
      <label>Empresa</label>
      <select id="empresaFiltro"><option value="">Todas</option></select>
    </div>
    <button onclick="carregar(true)">🔄 Recarregar</button>
    <button onclick="exportarPDF()">📄 PDF</button>
    <button onclick="enviarWhatsapp()">📲 WhatsApp</button>
  </div>

  <div id="painel"><p style="text-align:center;color:var(--muted)">Carregando dados...</p></div>
</div>

<div id="loading"><div><div class="spinner"></div><p>Carregando dados…</p></div></div>

<footer>© 2025 Grupo DV</footer>

<script>
const empresas=[
  {nome:"CARNEIRO MERCATTO RESTAURANTE",chave:"VAREJO_URL_MERCATTO",tipo:"COM_ALMOCO"},
  {nome:"CARNEIRO MERCATTO EMPÓRIO",chave:"VAREJO_URL_MERCATTO",tipo:"SEM_ALMOCO"},
  {nome:"DELICIA GOURMET",chave:"VAREJO_URL_DELICIA",tipo:"COM_ALMOCO"},
  {nome:"PADARIA DELICIA",chave:"VAREJO_URL_PADARIA",tipo:"SEM_ALMOCO"},
  {nome:"VILLA GOURMET",chave:"VAREJO_URL_VILLA",tipo:"COM_ALMOCO"}
];

// ===== MAPEAMENTO FINALIZADORAS =====
const finalizadoras={
"VAREJO_URL_MERCATTO":[
{id:"1",descricao:"DINHEIRO"},{id:"2",descricao:"CARTÃO CRÉDITO TEF"},
{id:"3",descricao:"CARTÃO DÉBITO TEF"},{id:"4",descricao:"PIX CNPJ"},
{id:"15",descricao:"PIX QRCODE POS"},{id:"17",descricao:"CRÉDITO POS"},
{id:"18",descricao:"DÉBITO POS"}],
"VAREJO_URL_DELICIA":[
{id:"1",descricao:"DINHEIRO"},{id:"4",descricao:"PIX CNPJ"},
{id:"15",descricao:"PIX QRCODE POS"},{id:"17",descricao:"CRÉDITO POS"},
{id:"18",descricao:"DÉBITO POS"},{id:"32",descricao:"PAGAMENTO ONLINE"}],
  "VAREJO_URL_PADARIA": [
  { id: "1", descricao: "DINHEIRO" },
  { id: "2", descricao: "CARTAO DE CREDITO" },
  { id: "3", descricao: "CARTAO DE DEBITO" },
  { id: "4", descricao: "PIX" },
  { id: "5", descricao: "BOLETO" },
  { id: "6", descricao: "CONSUMO FUNCIONARIOS" },
  { id: "8", descricao: "CARTAO VOUCHER" },
  { id: "10", descricao: "CREDITO DELIVERY" },
  { id: "11", descricao: "DEBITO DELIVERY" },
  { id: "12", descricao: "PIX OFFLINE" },
  { id: "13", descricao: "PAGAMENTO ONLINE" },
  { id: "14", descricao: "CONSUMO SOCIO" },
  { id: "15", descricao: "VOUCHER POS" },
  { id: "", descricao: "SEM FATURAMENTO" }
  ],
  "VAREJO_URL_VILLA": [
  { id: "1", descricao: "DINHEIRO" },
  { id: "2", descricao: "CARTAO DE DEBITO" },
  { id: "3", descricao: "CARTAO DE CREDITO" },
  { id: "4", descricao: "CREDIARIO CLIENTES" },
  { id: "5", descricao: "CONSUMO FUNCIONARIOS" },
  { id: "6", descricao: "VOUCHER" },
  { id: "11", descricao: "TRANSFERENCIA BANCAR" },
  { id: "12", descricao: "PIX" },
  { id: "17", descricao: "CATALOGO DELIVERY" },
  { id: "18", descricao: "CART CREDITO POS" },
  { id: "19", descricao: "CART DEBITO POS" },
  { id: "20", descricao: "PIX ITAU" },
  { id: "22", descricao: "PIX POS" },
  { id: "23", descricao: "VOUCHER POS" },
  { id: "24", descricao: "BONIFICACAO" },
  { id: "25", descricao: "CONSUMO SOCIO" },
  { id: "26", descricao: "ERROS GARCONS" },
  { id: "27", descricao: "BONIFICACAO GERENCIA" }
  ]
};
const brl=n=>(Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
function showLoading(){document.getElementById('loading').classList.add('show')}
function hideLoading(){document.getElementById('loading').classList.remove('show')}

// ===== PRINCIPAL =====
async function carregar(force=false){
 showLoading();
 const data=document.getElementById('dataFiltro').value||new Date(Date.now()-86400000).toISOString().slice(0,10);
 const cacheKey="resumo_"+data;
 const painel=document.getElementById('painel');
 let dados=localStorage.getItem(cacheKey);
 if(dados && !force){
   dados=JSON.parse(dados);
   montarPainel(dados);
   hideLoading();
   atualizarHoje();
   return;
 }

 let resultados=[];
 for(const emp of empresas){
   try{
     const login=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({empresa:emp.chave})});
     const {accessToken}=await login.json();
     const resp=await fetch('/api/recebimentos',{method:'POST',headers:{'Content-Type':'application/json'},
     body:JSON.stringify({token:accessToken,empresa:emp.chave,dataInicio:data,dataFim:data})});
     const json=await resp.json();
     resultados.push({empresa:emp,json});
   }catch(e){resultados.push({empresa:emp,error:e.message});}
 }
 localStorage.setItem(cacheKey,JSON.stringify(resultados));
 montarPainel(resultados);
 hideLoading();
 atualizarHoje();
}

// ===== ATUALIZAÇÃO EM SEGUNDO PLANO =====
async function atualizarHoje(){
 const hoje=new Date().toISOString().slice(0,10);
 const cacheKey="resumo_"+hoje;
 if(localStorage.getItem(cacheKey))return;
 try{
   const results=[];
   for(const emp of empresas){
     const login=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({empresa:emp.chave})});
     const {accessToken}=await login.json();
     const resp=await fetch('/api/recebimentos',{method:'POST',headers:{'Content-Type':'application/json'},
     body:JSON.stringify({token:accessToken,empresa:emp.chave,dataInicio:hoje,dataFim:hoje})});
     const json=await resp.json();
     results.push({empresa:emp,json});
   }
   localStorage.setItem(cacheKey,JSON.stringify(results));
 }catch(e){console.warn("falha atualização hoje",e);}
}

// ===== MONTAGEM DO PAINEL =====
function montarPainel(dados){
 const painel=document.getElementById('painel');
 painel.innerHTML="";
 dados.forEach(r=>{
   if(r.error){painel.innerHTML+=`<div class='card'><h2>${r.empresa.nome}</h2><p style='color:#ef4444'>${r.error}</p></div>`;return;}
   const itens=r.json.items||[];
   const formas={};let total=0;
   const mapFinal=finalizadoras[r.empresa.chave]||[];
   itens.forEach(v=>{
     const val=Number(v.valorTotal||0);total+=val;
     (v.finalizacoes||[]).forEach(f=>{
       const idF=String(f.finalizadoraId||'');
       const found=mapFinal.find(ff=>ff.id===idF);
       const nomeF=found?`${idF} - ${found.descricao}`:`${idF} - NÃO CATALOGADA`;
       formas[nomeF]=(formas[nomeF]||0)+Number(f.valor||0);
     });
   });
   let html=`<div class='card'><h2>${r.empresa.nome}</h2><div class='valor'>${brl(total)}</div><ul>`;
   Object.entries(formas).forEach(([k,v])=>{
     const classe=k.includes("NÃO CATALOGADA")?"desconhecida":"";
     html+=`<li class="${classe}">${k}: ${brl(v)}</li>`;
   });
   html+=`</ul><div class='chart'><canvas></canvas></div><div class='legend'></div></div>`;
   painel.insertAdjacentHTML('beforeend',html);
 });
 desenharGraficos();
}

// ===== GRÁFICOS =====
function desenharGraficos(){
 document.querySelectorAll('.card').forEach((c,idx)=>{
   const ctx=c.querySelector('canvas');
   const lis=[...c.querySelectorAll('li')];
   const labels=lis.map(li=>li.textContent.split(':')[0]);
   const vals=lis.map(li=>Number((li.textContent.split('R$')[1]||'0').replace('.','').replace(',','.')));
   const cores=labels.map((_,i)=>`hsl(${i*55},70%,60%)`);
   new Chart(ctx,{type:'bar',data:{labels,datasets:[{data:vals,backgroundColor:cores}]},
   options:{plugins:{legend:{display:false}},scales:{x:{ticks:{display:false}},y:{beginAtZero:true}}}});
   const legend=c.querySelector('.legend');
   labels.forEach((l,i)=>{const sp=document.createElement('span');sp.style.color=cores[i];sp.textContent=l;legend.appendChild(sp)});
 });
}

// ===== EXPORTAÇÃO =====
function exportarPDF(){
 const boxes=document.querySelectorAll('.card');
 boxes.forEach((b,i)=>{
   const wrap=document.createElement('div');
   wrap.style.width='1000px';wrap.style.padding='30px';wrap.style.background='#fff';wrap.style.color='#000';
   const h=document.createElement('h1');h.textContent='Resumo Financeiro - Grupo DV';h.style.textAlign='center';wrap.appendChild(h);
   const clone=b.cloneNode(true);clone.style.pageBreakAfter='always';wrap.appendChild(clone);
   html2pdf().from(wrap).set({margin:0,filename:`resumo-${i+1}.pdf`,
   image:{type:'jpeg',quality:1},html2canvas:{scale:2,useCORS:true},
   jsPDF:{unit:'px',format:[1000,800],orientation:'landscape'}}).save();
 });
}

// ===== WHATSAPP =====
function enviarWhatsapp(){
 const boxes=document.querySelectorAll('.card');
 let msg=`📊 *Resumo Financeiro - Grupo DV*\n\n`;
 boxes.forEach(b=>{
   msg+=`*${b.querySelector('h2').innerText}*\n`;
   b.querySelectorAll('li').forEach(li=>msg+=`• ${li.innerText}\n`);
   msg+='\n';
 });
 window.open(`https://wa.me/5577999761436?text=${encodeURIComponent(msg)}`,'_blank');
}

// ===== INICIALIZAÇÃO =====
document.addEventListener('DOMContentLoaded',()=>{
 const hoje=new Date(),ontem=new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate()-1);
 document.getElementById('dataFiltro').value=ontem.toISOString().slice(0,10);
 carregar();
});
document.getElementById('themeToggle').onclick=()=>{
 const cur=document.documentElement.getAttribute('data-theme')||'light';
 const next=cur==='light'?'dark':'light';
 document.documentElement.setAttribute('data-theme',next);
 localStorage.setItem('dv_theme',next);
};
</script>
</body>
</html>
