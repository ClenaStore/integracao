<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta Recebimentos Mercatto</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root { 
    --bg:#0b1220;
    --ink:#e5f0ff;
    --muted:#a8b3c7;
    --teal:#06b6d4;
    --red:#ef4444;
    --green:#16a34a;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:'Inter',system-ui;padding:20px;}
  h1{text-align:center;margin-bottom:20px;color:var(--teal);}
  .controls{text-align:center;margin-bottom:20px;}
  input,button{padding:8px 10px;margin:4px;border-radius:6px;border:none;font-size:14px;}
  button{background:var(--teal);color:#fff;font-weight:600;cursor:pointer;}
  #cards{display:flex;justify-content:center;gap:20px;flex-wrap:wrap;margin-bottom:18px}
  .card{background:#101827;padding:14px 22px;border-radius:10px;border:1px solid rgba(255,255,255,.06);min-width:220px;text-align:center}
  .card h2{margin:0 0 4px;color:var(--muted);font-size:.9rem}
  .card p{margin:0;font-weight:800;font-size:1.35rem}
  #layout{display:flex;gap:40px;align-items:flex-start}
  #resumo{width:40%;white-space:pre;line-height:1.5;font-size:14px}
  #saida{flex:1;background:#111a2e;padding:20px;border-radius:8px;overflow:auto;font-size:12px;color:#00ffaa}
  #erros{margin-top:20px;padding:10px;background:#1a1a2f;border-radius:8px;color:var(--red);font-size:13px;white-space:pre-line;}
  #finalizadoras{margin-top:20px;padding:10px;background:#111a2e;border-radius:8px;color:var(--ink);font-size:14px;}
  #finalizadoras span{display:block;margin-bottom:4px;}
  .ok{color:var(--green);}
  .erro{color:var(--red);}
  @media(max-width:900px){#layout{flex-direction:column}#resumo{width:100%}}
</style>
</head>
<body>
  <h1>Consulta Recebimentos Mercatto</h1>

  <div class="controls">
    <input type="date" id="dataInicio">
    <input type="date" id="dataFim">
    <button onclick="consultar()">Consultar</button>
  </div>

  <div id="cards">
    <div class="card"><h2>Total Geral</h2><p id="totalGeral">R$ 0,00</p></div>
    <div class="card"><h2>Restaurante Mercatto</h2><p id="totalRestaurante">R$ 0,00</p></div>
    <div class="card"><h2>Emp√≥rio Mercatto</h2><p id="totalEmporio">R$ 0,00</p></div>
  </div>

  <div id="layout">
    <div id="resumo">Aguardando consulta...</div>
    <pre id="saida">Aguardando consulta...</pre>
  </div>

  <div id="erros"></div>
  <div id="finalizadoras"></div>

<script>
// üîπ Finalizadoras atualizadas sem zero √† esquerda
const formasPagamento = [
  { id: "1",  descricao: "DINHEIRO" },
  { id: "2",  descricao: "CARTAO CREDITO TEF" },
  { id: "3",  descricao: "CARTAO DEBITO TEF" },
  { id: "4",  descricao: "PIX CNPJ" },
  { id: "5",  descricao: "CONSUMO FUNCIONARIOS" },
  { id: "6",  descricao: "REFEICAO ALIME. TEF" },
  { id: "7",  descricao: "TOTEM CREDITO" },
  { id: "8",  descricao: "TOTEM DEBITO" },
  { id: "9",  descricao: "BONIFICACAO" },
  { id: "15", descricao: "PIX QRCODE POS" },
  { id: "16", descricao: "PIX TEF" },
  { id: "17", descricao: "CREDITO POS" },
  { id: "18", descricao: "DEBITO POS" },
  { id: "19", descricao: "CART ALIMENTACAO POS" },
  { id: "25", descricao: "BOLETO MERCATTO KIDS" },
  { id: "26", descricao: "CREDIARIO CLIENTES" },
  { id: "27", descricao: "CONSUMO SOCIO" },
  { id: "29", descricao: "VOUCHER" },
  { id: "32", descricao: "PAGAMENTO ONLINE" },
  { id: "34", descricao: "MARKETING" },
  { id: "36", descricao: "PREJUIZO" },
  { id: "999", descricao: "SEM FATURAMENTO" }
];

const brl = n => n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

function valorFinalizacaoLiquido(f){
  const v  = Number(f.valor||0);
  const tr = Number(f.troco||0);
  const td = Number(f.trocoDoacao||0);
  const dm = Number(f.descontoMoeda||0);
  const jp = Number(f.jurosPlano||0);
  return v - tr - td - dm + jp;
}

async function consultar(){
  const dataInicio = document.getElementById('dataInicio').value;
  const dataFim    = document.getElementById('dataFim').value;
  const saida  = document.getElementById('saida');
  const resumo = document.getElementById('resumo');
  const errosBox = document.getElementById('erros');
  const finalizadorasBox = document.getElementById('finalizadoras');

  saida.textContent  = "üîÑ Buscando dados...";
  resumo.textContent = "üîÑ Processando...";
  errosBox.textContent = "";
  finalizadorasBox.textContent = "";

  try{
    // Login
    const loginResp = await fetch('/api/login',{method:'POST'});
    const {accessToken} = await loginResp.json();

    // Busca todos os cupons do dia (ignora hora)
    const resp = await fetch('/api/recebimentos',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        token:accessToken,
        dataInicio,
        dataFim,
        horaInicio:"00:00",
        horaFim:"23:59"
      })
    });
    const raw = await resp.json();
    saida.textContent = JSON.stringify(raw,null,2);

    const vendas = raw.items || [];
    const erros = [];
    const usados = {};

    // Usa todos os cupons que tenham dataVenda ou data
    const filtradas = vendas.filter(v=>{
      const dia = v.dataVenda || v.data;
      if(!dia){
        erros.push(`ID ${v.id} - Cupom sem data v√°lida`);
        return false;
      }
      return true;
    });

    let totalGeral=0,totalEmporio=0,totalRestaurante=0,cancelados=0;
    const caixas={};

    for(const v of filtradas){
      const cx=parseInt(v.numeroCaixa||"0",10);
      const fins=Array.isArray(v.finalizacoes)?v.finalizacoes:[];
      const cancelado = (v.valorItensCancelados>0 || v.qtdItensCancelados>0);
      if(cancelado) cancelados++;
      let somaCupom=0;
      fins.forEach(f=>{
        const val=cancelado?0:valorFinalizacaoLiquido(f);
        somaCupom+=val;
        const idf=(f.finalizadoraId||"?").replace(/^0+/,""); // remove zeros √† esquerda
        const forma=formasPagamento.find(fp=>fp.id==idf);
        const nome=forma?forma.descricao:null;
        usados[idf]=nome;
        if(!caixas[cx]) caixas[cx]=[];
        caixas[cx].push(`Finalizadora ${idf}${nome?" - "+nome:""}: ${brl(val)}`);
      });
      totalGeral+=somaCupom;
      if(cx>=1&&cx<=5) totalEmporio+=somaCupom;
      if(cx>5) totalRestaurante+=somaCupom;
    }

    document.getElementById('totalGeral').innerText=brl(totalGeral);
    document.getElementById('totalEmporio').innerText=brl(totalEmporio);
    document.getElementById('totalRestaurante').innerText=brl(totalRestaurante);

    let html=`üßæ Total de cupons: ${filtradas.length}\n‚ùå Cancelados: ${cancelados}\n\n`;
    for(const [cx,itens] of Object.entries(caixas)){
      html+=`Caixa ${cx}\n`;
      html+=itens.map(i=>"‚îú‚îÄ "+i).join("\n")+"\n\n";
    }
    resumo.textContent=html||'Nenhum dado no dia selecionado.';

    if(erros.length>0){
      errosBox.innerHTML = `‚ö†Ô∏è Cupons com erro (${erros.length}):\n` + erros.join("\n");
    }

    // Lista de finalizadoras encontradas
    let finalHtml = "<b>üßæ Finalizadoras encontradas:</b><br>";
    for(const [idf,nome] of Object.entries(usados)){
      if(nome){
        finalHtml += `<span class="ok">‚úÖ ${idf} - ${nome}</span>`;
      }else{
        finalHtml += `<span class="erro">‚ùå ${idf} - N√£o catalogada</span>`;
      }
    }
    finalizadorasBox.innerHTML = finalHtml;

  }catch(e){
    saida.textContent='Erro: '+e.message;
    resumo.textContent='Erro ao buscar dados.';
  }
}
</script>
</body>
</html>
