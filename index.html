<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Recebimentos ‚Ä¢ Mercatto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f4f6fb; --text:#111827; --muted:#6b7280; --card:#fff; --brand:#2563eb; --danger:#dc2626;
      --shadow:0 8px 26px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:24px 16px;text-align:center;font-weight:800;font-size:clamp(20px,2.5vw,36px)}
    .filters{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;align-items:center;margin:0 auto 18px;padding:0 12px}
    .grp{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:600}
    input[type="date"],input[type="time"]{
      padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;min-width:160px;color:var(--text)
    }
    button{
      padding:12px 16px;border-radius:12px;border:none;background:var(--brand);color:#fff;font-weight:700;cursor:pointer;
      box-shadow:var(--shadow);transition:transform .08s ease;
    }
    button:active{transform:translateY(1px)}
    #err{color:var(--danger);text-align:center;font-weight:700;margin:6px 0 10px}
    .cards{max-width:1300px;margin:0 auto 40px;padding:0 16px;display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1000px){.cards{grid-template-columns:1fr 1fr}}
    .card{
      background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:22px 20px;min-height:120px
    }
    .card h3{margin:0 0 12px;font-size:20px}
    .ln{display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px dashed #eef1f6}
    .ln:last-child{border-bottom:none}
    .name{font-weight:700}
    .val{font-variant-numeric:tabular-nums;font-weight:800}
    #overlay{
      position:fixed;inset:0;background:rgba(255,255,255,.6);display:none;place-items:center;z-index:9999;font-weight:800;
      color:var(--brand);backdrop-filter:saturate(150%) blur(2px)
    }
    .pill{display:inline-flex;gap:8px;align-items:center;background:#eef2ff;color:#3730a3;padding:6px 10px;border-radius:999px;font-weight:700}
  </style>
</head>
<body>
  <header>Recebimentos</header>

  <div class="filters">
    <div class="grp">Data Inicial: <input id="dIni" type="date"></div>
    <div class="grp">Hora Inicial: <input id="hIni" type="time" value="08:00"></div>
    <div class="grp">Data Final: <input id="dFim" type="date"></div>
    <div class="grp">Hora Final: <input id="hFim" type="time" value="23:59"></div>
    <button id="bt">Filtrar</button>
  </div>

  <div id="err"></div>

  <div class="cards">
    <div class="card">
      <h3>CARNEIRO MERCATTO RESTAURANTE <span id="almocoPill" class="pill" style="display:none;">üçΩÔ∏è Almo√ßo: <span id="almocoVal">R$ 0,00</span></span></h3>
      <div id="rest"></div>
    </div>
    <div class="card">
      <h3>CARNEIRO MERCATTO EMP√ìRIO</h3>
      <div id="emp"></div>
    </div>
  </div>

  <div id="overlay">‚è≥ Processando‚Ä¶</div>

  <script>
    const EMOJIS = {
      "dinheiro":"üíµ","cr√©dito":"üí≥","d√©bito":"üèß","pix":"‚ö°","online":"üåê","consumo interno":"üçΩÔ∏è",
      "bonifica√ß√£o":"üéÅ","voucher":"üéüÔ∏è","boleto":"üì¶","credi√°rio":"üìí","cat√°logo delivery":"üì±",
      "consumo s√≥cio":"üë•","marketing":"üì¢","transfer√™ncia banc√°ria":"üè¶","erros gar√ßom":"üßæ",
      "sem faturamento":"üö´","outros":"‚ùáÔ∏è"
    };

    const $ = s => document.querySelector(s);
    const BRL = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    // default datas: hoje
    const today = new Date().toISOString().slice(0,10);
    $('#dIni').value = today;
    $('#dFim').value = today;

    $('#bt').addEventListener('click', carregar);
    window.addEventListener('load', carregar);

    function buildISO(d, t){
      // d = YYYY-MM-DD | t = HH:MM
      return `${d}T${t}:00`;
    }

    async function carregar(){
      $('#err').textContent = '';
      $('#overlay').style.display = 'grid';

      const dataIni = buildISO($('#dIni').value, $('#hIni').value || '00:00');
      const dataFim = buildISO($('#dFim').value, $('#hFim').value || '23:59');

      try{
        const url = `/api/recebimentos?dataIni=${encodeURIComponent(dataIni)}&dataFim=${encodeURIComponent(dataFim)}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error(`API ${r.status}`);
        const data = await r.json();

        renderSec('#rest', data.restaurante);
        renderSec('#emp',  data.emporio);

        if(data.almoco && data.almoco > 0){
          $('#almocoVal').textContent = BRL(data.almoco);
          $('#almocoPill').style.display = 'inline-flex';
        }else{
          $('#almocoPill').style.display = 'none';
        }
      }catch(e){
        $('#err').textContent = 'Erro ao buscar dados';
        console.error(e);
      }finally{
        $('#overlay').style.display = 'none';
      }
    }

    function renderSec(sel, obj){
      const el = document.querySelector(sel);
      el.innerHTML = '';
      // s√≥ mostra modalidades com valor > 0
      Object.entries(obj)
        .filter(([,v])=>v>0)
        .sort((a,b)=>b[1]-a[1])
        .forEach(([k,v])=>{
          const div = document.createElement('div');
          div.className = 'ln';
          div.innerHTML = `
            <div class="name">${EMOJIS[k] || '‚ùáÔ∏è'} ${k.toUpperCase()}</div>
            <div class="val">${BRL(v)}</div>
          `;
          el.appendChild(div);
        });

      if(!el.children.length){
        el.innerHTML = `<div class="ln"><div class="name" style="color:#9ca3af">Sem movimenta√ß√£o</div><div class="val">‚Äî</div></div>`;
      }
    }
  </script>
</body>
</html>
