<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel de Recebimentos Mercatto</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg:#f9fafb;
  --card:#ffffff;
  --ink:#0f172a;
  --muted:#6b7280;
  --line:#e5e7eb;
  --brand:#2563eb;
  --radius:12px;
  --shadow:0 4px 14px rgba(15,23,42,0.08);
}
body {
  margin:0;
  font-family:'Inter',system-ui;
  background:var(--bg);
  color:var(--ink);
  padding:20px;
}
h1 {
  text-align:center;
  margin-bottom:20px;
  color:var(--brand);
  font-weight:800;
}
.controls {
  text-align:center;
  margin-bottom:20px;
}
input,button {
  padding:8px 10px;
  margin:4px;
  border-radius:6px;
  border:1px solid var(--line);
  font-size:14px;
}
button {
  background:var(--brand);
  color:#fff;
  font-weight:600;
  cursor:pointer;
  border:none;
}
#cards {
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  gap:20px;
  margin-bottom:25px;
}
.card {
  background:var(--card);
  box-shadow:var(--shadow);
  border-radius:var(--radius);
  padding:20px;
  min-width:280px;
  flex:1;
  text-align:center;
  transition:transform .2s;
}
.card:hover { transform:translateY(-3px); }
.card h2 { margin:0; color:var(--muted); font-size:.9rem; font-weight:600; }
.card p { margin:8px 0 0; font-weight:800; font-size:1.5rem; color:var(--ink); }
.section {
  display:flex;
  flex-wrap:wrap;
  gap:30px;
  justify-content:center;
}
canvas { max-width:400px; }
#resumo {
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  max-width:900px;
  margin:30px auto;
  white-space:pre-line;
  font-size:14px;
  line-height:1.5;
}
</style>
</head>
<body>
<h1>Painel de Recebimentos Mercatto</h1>

<div class="controls">
  <input type="date" id="dataInicio">
  <input type="date" id="dataFim">
  <button onclick="consultar()">Consultar</button>
</div>

<div id="cards">
  <div class="card"><h2>Total Geral</h2><p id="totalGeral">R$ 0,00</p></div>
  <div class="card"><h2>Restaurante Mercatto</h2><p id="totalRestaurante">R$ 0,00</p></div>
  <div class="card"><h2>Emp√≥rio Mercatto</h2><p id="totalEmporio">R$ 0,00</p></div>
</div>

<div class="section">
  <canvas id="graficoRestaurante"></canvas>
  <canvas id="graficoEmporio"></canvas>
</div>

<div id="resumo">Aguardando consulta...</div>

<script>
const brl = n => n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const normaliza = s => (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
function encontrarGrupo(desc){
  const grupos={
    "Cr√©dito":["credito","cartao credito","totem credito","credito pos","pgto online credito"],
    "D√©bito":["debito","pgto online debito","cartao debito","totem debito","debito pos"],
    "Pix":["pix","pgto online pix","qrcode","pix tef","pix cnpj"],
    "Dinheiro":["dinheiro","pgto online dinheiro"],
    "Boleto":["boleto"],
    "Voucher":["voucher"],
    "Consumo Interno":["funcionario","consumo funcionarios","socio"],
    "Outros":[]
  };
  const d=normaliza(desc);
  for(const [g,ts] of Object.entries(grupos)){ if(ts.some(t=>d.includes(t))) return g; }
  return "Outros";
}
function valorFinalizacaoLiquido(f){
  const v=Number(f.valor||0),tr=Number(f.troco||0),td=Number(f.trocoDoacao||0),dm=Number(f.descontoMoeda||0),jp=Number(f.jurosPlano||0);
  return v - tr - td - dm + jp;
}
function toDateLocal(v){
  const hhmm=String(v.hora||"0000").padStart(4,"0");
  return new Date(`${v.data}T${hhmm.slice(0,2)}:${hhmm.slice(2)}:00`);
}

window.addEventListener('load',()=>{
  const hoje=new Date();
  const ontem=new Date(hoje); ontem.setDate(hoje.getDate()-1);
  const data=ontem.toISOString().slice(0,10);
  document.getElementById('dataInicio').value=data;
  document.getElementById('dataFim').value=data;
  consultar();
});

async function consultar(){
  const dataInicio=document.getElementById('dataInicio').value;
  const dataFim=document.getElementById('dataFim').value;
  const resumo=document.getElementById('resumo');
  resumo.textContent="üîÑ Buscando dados...";

  try{
    const loginResp=await fetch('/api/login',{method:'POST'});
    const {accessToken}=await loginResp.json();
    const resp=await fetch('/api/recebimentos',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({token:accessToken,dataInicio,dataFim})
    });
    const raw=await resp.json();
    const vendas=raw.items||[];

    let totalGeral=0,totalRestaurante=0,totalEmporio=0;
    const gruposRest={},gruposEmp={};

    vendas.forEach(v=>{
      const cx=parseInt(v.numeroCaixa||"0",10);
      const fins=Array.isArray(v.finalizacoes)?v.finalizacoes:[];
      const somaCupom=fins.reduce((s,f)=>s+valorFinalizacaoLiquido(f),0);
      totalGeral+=somaCupom;

      fins.forEach(f=>{
        const forma=f.finalizadoraDescricao||"Desconhecida";
        const grupo=encontrarGrupo(forma);
        if(cx>=1&&cx<=5){
          totalEmporio+=valorFinalizacaoLiquido(f);
          gruposEmp[grupo]=(gruposEmp[grupo]||0)+valorFinalizacaoLiquido(f);
        }else if(cx>5){
          totalRestaurante+=valorFinalizacaoLiquido(f);
          gruposRest[grupo]=(gruposRest[grupo]||0)+valorFinalizacaoLiquido(f);
        }
      });
    });

    document.getElementById('totalGeral').innerText=brl(totalGeral);
    document.getElementById('totalRestaurante').innerText=brl(totalRestaurante);
    document.getElementById('totalEmporio').innerText=brl(totalEmporio);

    const makeChart=(id,labels,data,corTitulo)=>{
      const ctx=document.getElementById(id).getContext('2d');
      new Chart(ctx,{
        type:'bar',
        data:{labels,datasets:[{label:'Total (R$)',data,backgroundColor:'#2563eb'}]},
        options:{
          plugins:{title:{display:true,text:corTitulo,color:'#0f172a',font:{size:16,weight:'bold'}}},
          scales:{y:{ticks:{color:'#0f172a'}},x:{ticks:{color:'#0f172a'}}}
        }
      });
    };

    // Gerar gr√°ficos
    document.getElementById('graficoRestaurante').replaceWith(document.getElementById('graficoRestaurante').cloneNode(true));
    document.getElementById('graficoEmporio').replaceWith(document.getElementById('graficoEmporio').cloneNode(true));
    makeChart('graficoRestaurante',Object.keys(gruposRest),Object.values(gruposRest),'Restaurante Mercatto');
    makeChart('graficoEmporio',Object.keys(gruposEmp),Object.values(gruposEmp),'Emp√≥rio Mercatto');

    // Resumo
    let resumoTxt="üìä Resumo de Recebimentos\n\n";
    resumoTxt+=`Total Geral: ${brl(totalGeral)}\n`;
    resumoTxt+=`Restaurante: ${brl(totalRestaurante)}\n`;
    resumoTxt+=`Emp√≥rio: ${brl(totalEmporio)}\n\n`;
    resumoTxt+="--- Restaurante ---\n";
    for(const [g,v] of Object.entries(gruposRest)){resumoTxt+=`${g}: ${brl(v)}\n`;}
    resumoTxt+="\n--- Emp√≥rio ---\n";
    for(const [g,v] of Object.entries(gruposEmp)){resumoTxt+=`${g}: ${brl(v)}\n`;}
    resumo.textContent=resumoTxt;
  }catch(e){
    resumo.textContent="‚ùå Erro: "+e.message;
  }
}
</script>
</body>
</html>
